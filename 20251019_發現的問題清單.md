# èª æ†¶é®®è”¬ç·šä¸Šç³»çµ± - ç™¼ç¾çš„å•é¡Œæ¸…å–®

**æ¸¬è©¦æ—¥æœŸ**: 2025-10-19
**æ¸¬è©¦ç’°å¢ƒ**: Development
**å ±å‘Šç‰ˆæœ¬**: v1.0

---

## ğŸ”´ Critical / High åš´é‡åº¦å•é¡Œ

### BUG-001: Admin Products List API è¿”å›æ ¼å¼ä¸ç¬¦é æœŸ

**åš´é‡ç¨‹åº¦**: ğŸ”´ High
**ç™¼ç¾æ™‚é–“**: 2025-10-19 22:55
**ç‹€æ…‹**: ğŸ”´ Open
**å½±éŸ¿æ¨¡çµ„**: Product Management API
**å½±éŸ¿ç”¨æˆ¶**: ç®¡ç†å“¡

#### å•é¡Œæè¿°
ç®¡ç†å“¡å•†å“åˆ—è¡¨ API (`GET /api/v1/admin/products`) è¿”å›çš„è³‡æ–™çµæ§‹èˆ‡é æœŸä¸ç¬¦ï¼Œå°è‡´å‰ç«¯ç„¡æ³•æ­£ç¢ºè§£æå•†å“åˆ—è¡¨ã€‚

#### é‡ç¾æ­¥é©Ÿ
1. ä½¿ç”¨ç®¡ç†å“¡å¸³è™Ÿç™»å…¥ (`admin@chengyi.tw`)
2. å‘¼å« API: `GET /api/v1/admin/products`
3. æª¢æŸ¥è¿”å›çš„ JSON çµæ§‹

#### é æœŸè¡Œç‚º
```json
{
  "data": {
    "products": [...],
    "stats": {...}
  }
}
```

#### å¯¦éš›è¡Œç‚º
è¿”å›çµæ§‹å°è‡´æ¸¬è©¦ä¸­ `response.data.data.products` ä¸æ˜¯é™£åˆ—ã€‚

#### å½±éŸ¿ç¯„åœ
- ç®¡ç†å¾Œå°å•†å“åˆ—è¡¨é é¢
- å•†å“çµ±è¨ˆè³‡è¨Šé¡¯ç¤º
- ä¾è³´æ­¤ API çš„å…¶ä»–åŠŸèƒ½

#### ä¿®å¾©å»ºè­°
1. æª¢æŸ¥ `AdminProductsController.list()` æ–¹æ³•
2. ç¢ºèª `ProductService.listWithStats()` çš„è¿”å›æ ¼å¼
3. çµ±ä¸€ API è¿”å›æ ¼å¼è¦ç¯„ï¼Œå»ºè­°ä½¿ç”¨:
   ```typescript
   {
     data: {
       products: Product[],
       stats: {
         total: number,
         available: number,
         ...
       }
     }
   }
   ```

#### ç›¸é—œæ–‡ä»¶
- æ–‡ä»¶ä½ç½®: `apps/api/src/application/controllers/admin-products.controller.ts`
- æœå‹™ä½ç½®: `apps/api/src/domain/product-service.ts`

---

### BUG-005: è¼¸å…¥é©—è­‰éŒ¯èª¤å°è‡´ API é€£æ¥å¤±æ•—

**åš´é‡ç¨‹åº¦**: ğŸ”´ High
**ç™¼ç¾æ™‚é–“**: 2025-10-19 23:03
**ç‹€æ…‹**: ğŸ”´ Open
**å½±éŸ¿æ¨¡çµ„**: API Error Handling
**å½±éŸ¿ç”¨æˆ¶**: æ‰€æœ‰ç”¨æˆ¶

#### å•é¡Œæè¿°
ç•¶å®¢æˆ¶ç«¯ç™¼é€ç„¡æ•ˆçš„è«‹æ±‚è³‡æ–™æ™‚ï¼ŒAPI æ‹‹å‡º ZodError ä½†æ²’æœ‰è¢«æ­£ç¢ºè™•ç†ï¼Œå°è‡´å®¢æˆ¶ç«¯æ”¶åˆ°é€£æ¥å¤±æ•—éŒ¯èª¤è€Œéæ¨™æº–çš„ HTTP 400 éŒ¯èª¤éŸ¿æ‡‰ã€‚

#### é‡ç¾æ­¥é©Ÿ
1. ç™¼é€ç¼ºå°‘å¿…å¡«æ¬„ä½çš„å•†å“å»ºç«‹è«‹æ±‚:
   ```json
   POST /api/v1/products
   {
     "name": "æ¸¬è©¦å•†å“"
     // ç¼ºå°‘ category, unit ç­‰å¿…å¡«æ¬„ä½
   }
   ```
2. è§€å¯Ÿå®¢æˆ¶ç«¯æ”¶åˆ°çš„éŒ¯èª¤

#### é æœŸè¡Œç‚º
```json
HTTP 400 Bad Request
{
  "error": "VALIDATION_ERROR",
  "issues": {
    "category": ["Required"],
    "unit": ["Required"]
  }
}
```

#### å¯¦éš›è¡Œç‚º
- å®¢æˆ¶ç«¯æ”¶åˆ° "Request failed: fetch failed"
- API æ—¥èªŒé¡¯ç¤ºæœªæ•ç²çš„ ZodError:
  ```
  ZodError: [
    {
      "code": "invalid_type",
      "expected": "string",
      "received": "undefined",
      "path": [ "category" ],
      "message": "Required"
    }
  ]
  ```

#### å½±éŸ¿ç¯„åœ
- æ‰€æœ‰ä½¿ç”¨ Zod é©—è­‰çš„ API ç«¯é»
- ç”¨æˆ¶é«”é©—å·®ï¼Œç„¡æ³•å¾—çŸ¥å…·é«”éŒ¯èª¤åŸå› 
- å¯èƒ½å½±éŸ¿å‰ç«¯éŒ¯èª¤è™•ç†é‚è¼¯

#### ä¿®å¾©å»ºè­°

1. **åœ¨ Controller å±¤å¢åŠ éŒ¯èª¤è™•ç†**:
   ```typescript
   try {
     const parsed = createProductSchema.parse(req.body);
     // ... è™•ç†é‚è¼¯
   } catch (error) {
     if (error instanceof ZodError) {
       return res.status(400).json({
         error: 'VALIDATION_ERROR',
         issues: error.flatten()
       });
     }
     throw error;
   }
   ```

2. **å¢åŠ å…¨å±€éŒ¯èª¤è™•ç†ä¸­é–“ä»¶** (å¦‚æœå°šæœªå®Œå–„):
   ```typescript
   app.use((err, req, res, next) => {
     if (err instanceof ZodError) {
       return res.status(400).json({
         error: 'VALIDATION_ERROR',
         issues: err.flatten()
       });
     }
     // ... å…¶ä»–éŒ¯èª¤è™•ç†
   });
   ```

3. **ç¢ºä¿æ‰€æœ‰ async å‡½æ•¸çš„éŒ¯èª¤éƒ½è¢«æ•ç²**

#### ç›¸é—œæ–‡ä»¶
- æ–‡ä»¶ä½ç½®: `apps/api/src/application/controllers/product.controller.ts`
- éŒ¯èª¤è™•ç†: `apps/api/src/app.ts` (å…¨å±€éŒ¯èª¤è™•ç†ä¸­é–“ä»¶)

---

## ğŸŸ¡ Medium åš´é‡åº¦å•é¡Œ

### BUG-002: Bulk Upsert åŠŸèƒ½ç„¡æ•ˆ

**åš´é‡ç¨‹åº¦**: ğŸŸ¡ Medium
**ç™¼ç¾æ™‚é–“**: 2025-10-19 22:56
**ç‹€æ…‹**: ğŸ”´ Open
**å½±éŸ¿æ¨¡çµ„**: Product Management API
**å½±éŸ¿ç”¨æˆ¶**: ç®¡ç†å“¡

#### å•é¡Œæè¿°
æ‰¹æ¬¡æ–°å¢/æ›´æ–°å•†å“åŠŸèƒ½ (`POST /api/v1/admin/products/bulk`) ç„¡æ³•å»ºç«‹æˆ–æ›´æ–°å•†å“ï¼Œè¿”å›ç©ºé™£åˆ—ã€‚

#### é‡ç¾æ­¥é©Ÿ
1. ä½¿ç”¨ç®¡ç†å“¡å¸³è™Ÿç™»å…¥
2. æº–å‚™æ‰¹æ¬¡å•†å“è³‡æ–™:
   ```json
   POST /api/v1/admin/products/bulk
   [
     {
       "name": "æ‰¹æ¬¡å•†å“1",
       "category": "æ¸¬è©¦",
       "unit": "å€‹",
       "price": 80,
       "stock": 40,
       "isAvailable": true,
       "isPricedItem": false,
       "options": []
     },
     {
       "name": "æ‰¹æ¬¡å•†å“2",
       "category": "æ¸¬è©¦",
       "unit": "åŒ…",
       "price": 120,
       "stock": 25,
       "isAvailable": true,
       "isPricedItem": false,
       "options": []
     }
   ]
   ```
3. æª¢æŸ¥è¿”å›çµæœ

#### é æœŸè¡Œç‚º
```json
{
  "data": [
    { "id": "...", "name": "æ‰¹æ¬¡å•†å“1", ... },
    { "id": "...", "name": "æ‰¹æ¬¡å•†å“2", ... }
  ]
}
```

#### å¯¦éš›è¡Œç‚º
```json
{
  "data": []
}
```

#### å½±éŸ¿ç¯„åœ
- CSV åŒ¯å…¥åŠŸèƒ½å¯èƒ½å—å½±éŸ¿
- æ‰¹æ¬¡å•†å“ç®¡ç†åŠŸèƒ½ç„¡æ³•ä½¿ç”¨

#### ä¿®å¾©å»ºè­°
1. æª¢æŸ¥ `ProductService.bulkUpsert()` æ–¹æ³•
2. é©—è­‰è³‡æ–™åº«äº¤æ˜“æ˜¯å¦æ­£ç¢ºæäº¤
3. ç¢ºèªè«‹æ±‚é«”è§£ææ˜¯å¦æ­£ç¢º
4. å¢åŠ æ—¥èªŒè¼¸å‡ºä»¥ä¾¿é™¤éŒ¯

#### ç›¸é—œæ–‡ä»¶
- æ–‡ä»¶ä½ç½®: `apps/api/src/domain/product-service.ts`
- Controller: `apps/api/src/application/controllers/admin-products.controller.ts`

---

### BUG-003: Reorder Products åŠŸèƒ½ç™¼ç”Ÿ Undefined éŒ¯èª¤

**åš´é‡ç¨‹åº¦**: ğŸŸ¡ Medium
**ç™¼ç¾æ™‚é–“**: 2025-10-19 22:57
**ç‹€æ…‹**: ğŸ”´ Open
**å½±éŸ¿æ¨¡çµ„**: Product Management API
**å½±éŸ¿ç”¨æˆ¶**: ç®¡ç†å“¡

#### å•é¡Œæè¿°
å•†å“æ’åºåŠŸèƒ½ (`POST /api/v1/admin/products/reorder`) ç™¼ç”Ÿ undefined éŒ¯èª¤ã€‚

#### éŒ¯èª¤è¨Šæ¯
```
Cannot read properties of undefined (reading 'length')
```

#### é‡ç¾æ­¥é©Ÿ
1. ä½¿ç”¨ç®¡ç†å“¡å¸³è™Ÿç™»å…¥
2. å–å¾—å•†å“åˆ—è¡¨
3. æº–å‚™æ’åºè³‡æ–™ä¸¦æäº¤

#### é æœŸè¡Œç‚º
æˆåŠŸæ›´æ–°å•†å“é †åº

#### å¯¦éš›è¡Œç‚º
ç™¼ç”Ÿ undefined éŒ¯èª¤

#### å¯èƒ½åŸå› 
- BUG-001 çš„å»¶ä¼¸å•é¡Œï¼ˆadmin products list è¿”å›æ ¼å¼ä¸æ­£ç¢ºï¼‰
- æ’åºè³‡æ–™é©—è­‰é‚è¼¯æœ‰å•é¡Œ
- æœªæ­£ç¢ºè™•ç†ç©ºé™£åˆ—æƒ…æ³

#### ä¿®å¾©å»ºè­°
1. å…ˆä¿®å¾© BUG-001
2. å¢åŠ è¼¸å…¥è³‡æ–™é©—è­‰
3. å¢åŠ ç©ºé™£åˆ—æª¢æŸ¥
4. æ”¹å–„éŒ¯èª¤è¨Šæ¯

#### ç›¸é—œæ–‡ä»¶
- æ–‡ä»¶ä½ç½®: `apps/api/src/application/controllers/admin-products.controller.ts`

---

### BUG-006: åƒ¹æ ¼åŒæ­¥æ“ä½œæ€§èƒ½å•é¡Œ

**åš´é‡ç¨‹åº¦**: ğŸŸ¡ Medium
**ç™¼ç¾æ™‚é–“**: 2025-10-19 22:58
**ç‹€æ…‹**: ğŸ”´ Open
**å½±éŸ¿æ¨¡çµ„**: Product Management Service
**å½±éŸ¿ç”¨æˆ¶**: ç®¡ç†å“¡

#### å•é¡Œæè¿°
åŒæ­¥éš”æ—¥åƒ¹æ ¼åŠŸèƒ½åŸ·è¡Œæ™‚é–“éé•·ï¼Œå½±éŸ¿ç”¨æˆ¶é«”é©—ã€‚

#### æ€§èƒ½æ•¸æ“š
- åŸ·è¡Œæ™‚é–“: 4313ms (4.3 ç§’)
- é æœŸæ™‚é–“: < 1000ms

#### å½±éŸ¿ç¯„åœ
- ç®¡ç†å¾Œå°æ“ä½œé«”é©—
- å¯èƒ½å½±éŸ¿å…¶ä»–ä¸¦ç™¼è«‹æ±‚

#### ä¿®å¾©å»ºè­°
1. ä½¿ç”¨æ‰¹æ¬¡æ›´æ–°è€Œéé€ä¸€æ›´æ–°:
   ```typescript
   // ä¸å¥½çš„åšæ³•
   for (const product of products) {
     await prisma.product.update({...});
   }

   // è¼ƒå¥½çš„åšæ³•
   await prisma.$transaction(
     products.map(p =>
       prisma.product.update({...})
     )
   );

   // æœ€ä½³åšæ³•
   await prisma.product.updateMany({
     data: { ... },
     where: { ... }
   });
   ```

2. è€ƒæ…®ä½¿ç”¨èƒŒæ™¯ä»»å‹™è™•ç†
3. å¢åŠ é€²åº¦å›é¥‹æ©Ÿåˆ¶

#### ç›¸é—œæ–‡ä»¶
- æ–‡ä»¶ä½ç½®: `apps/api/src/domain/product-service.ts` (syncNextDayPrices æ–¹æ³•)

---

## ğŸŸ¢ Low åš´é‡åº¦å•é¡Œ

### BUG-004: Sync Next Day Prices API è¿”å›æ ¼å¼ç¼ºå°‘æ¬„ä½

**åš´é‡ç¨‹åº¦**: ğŸŸ¢ Low
**ç™¼ç¾æ™‚é–“**: 2025-10-19 22:58
**ç‹€æ…‹**: ğŸ”´ Open
**å½±éŸ¿æ¨¡çµ„**: Product Management API
**å½±éŸ¿ç”¨æˆ¶**: ç®¡ç†å“¡

#### å•é¡Œæè¿°
åŒæ­¥éš”æ—¥åƒ¹æ ¼ API è¿”å›è³‡æ–™ä¸­ç¼ºå°‘ `updated` æ¬„ä½ï¼Œå‰ç«¯ç„¡æ³•å¾—çŸ¥æ›´æ–°äº†å¤šå°‘å•†å“ã€‚

#### é‡ç¾æ­¥é©Ÿ
1. ä½¿ç”¨ç®¡ç†å“¡å¸³è™Ÿç™»å…¥
2. å‘¼å«: `POST /api/v1/admin/products/sync-next-day-prices`
3. æª¢æŸ¥è¿”å›çµæœ

#### é æœŸè¡Œç‚º
```json
{
  "data": {
    "updated": 6,
    "products": [...]
  }
}
```

#### å¯¦éš›è¡Œç‚º
è¿”å›è³‡æ–™ä¸­å¯èƒ½ç¼ºå°‘ `updated` æ¬„ä½

#### å½±éŸ¿ç¯„åœ
- å‰ç«¯ç„¡æ³•é¡¯ç¤ºæ›´æ–°æˆåŠŸçš„å•†å“æ•¸é‡
- å½±éŸ¿ç”¨æˆ¶é«”é©—

#### ä¿®å¾©å»ºè­°
ç¢ºä¿ `ProductService.syncNextDayPrices()` è¿”å›æ­£ç¢ºæ ¼å¼:
```typescript
return {
  updated: updated.length,
  products: updated
};
```

#### ç›¸é—œæ–‡ä»¶
- æ–‡ä»¶ä½ç½®: `apps/api/src/domain/product-service.ts`

---

## ğŸ“Š å•é¡Œçµ±è¨ˆ

### æŒ‰åš´é‡ç¨‹åº¦åˆ†é¡
- ğŸ”´ High: 2
- ğŸŸ¡ Medium: 3
- ğŸŸ¢ Low: 1
- **ç¸½è¨ˆ**: 6

### æŒ‰æ¨¡çµ„åˆ†é¡
- Product Management API: 5
- Error Handling: 1

### æŒ‰ç‹€æ…‹åˆ†é¡
- ğŸ”´ Open: 6
- ğŸŸ¢ Fixed: 0
- ğŸ”µ In Progress: 0

---

## ğŸ”§ ä¿®å¾©å„ªå…ˆç´šå»ºè­°

### Phase 1: ç·Šæ€¥ä¿®å¾© (1-2 å¤©)
1. **BUG-005**: éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ (æœ€é«˜å„ªå…ˆ)
2. **BUG-001**: Admin Products List API æ ¼å¼

### Phase 2: é‡è¦ä¿®å¾© (3-4 å¤©)
3. **BUG-006**: æ€§èƒ½å„ªåŒ–
4. **BUG-002**: Bulk Upsert åŠŸèƒ½
5. **BUG-003**: Reorder åŠŸèƒ½

### Phase 3: ä¸€èˆ¬ä¿®å¾© (5 å¤©å¾Œ)
6. **BUG-004**: API è¿”å›æ ¼å¼å„ªåŒ–

---

## ğŸ“ æ¸¬è©¦å»ºè­°

ä¿®å¾©å®Œæˆå¾Œï¼Œå»ºè­°åŸ·è¡Œä»¥ä¸‹æ¸¬è©¦ï¼š

1. **å›æ­¸æ¸¬è©¦**: é‡æ–°åŸ·è¡Œæ‰€æœ‰å¤±æ•—çš„æ¸¬è©¦æ¡ˆä¾‹
2. **é›†æˆæ¸¬è©¦**: åŸ·è¡Œå®Œæ•´çš„è¨‚å–®ç®¡ç†å’Œ E2E æµç¨‹æ¸¬è©¦
3. **æ€§èƒ½æ¸¬è©¦**: é©—è­‰å„ªåŒ–å¾Œçš„æ€§èƒ½æ”¹å–„
4. **UAT æ¸¬è©¦**: è®“å¯¦éš›ç”¨æˆ¶æ¸¬è©¦ä¿®å¾©å¾Œçš„åŠŸèƒ½

---

## ğŸ“ è¯çµ¡è³‡è¨Š

å¦‚æœ‰ç–‘å•æˆ–éœ€è¦æ›´å¤šè³‡è¨Šï¼Œè«‹è¯çµ¡ï¼š
- **QA Team**: qa@chengyi.tw
- **æ¸¬è©¦å ±å‘Š**: `C:\chengyivegetable\20251019_å…¨åŠŸèƒ½æ¸¬è©¦å ±å‘Š.md`

---

**æœ€å¾Œæ›´æ–°**: 2025-10-19 23:15
