# 🥬 誠憶鮮蔬線上系統 - 完整功能概覽

> ⚠️ **重要提醒**：在修改任何代碼之前，必須先閱讀此文檔！

## 🎯 系統核心商業模式

### 📅 營業時間與訂購規則
- **營業時間**: 每日 08:00-20:00，週日公休
- **當日訂單**: 11:00前下單 → 當天配送
- **隔日預訂**: 14:00後開放 → 隔日配送
- **通過LINE圖文選單進入** (不需要用戶註冊系統)

### 💰 每日價格更新機制
- **每日7:30自動更新商品價格**
- **價差閾值**: 超過15%自動通知客戶
- **通知時限**: 客戶30分鐘內回覆確認
- **通知方式**: LINE推播通知

## 🏗️ 系統三端架構

### 🛒 前台系統 (客戶端)
**已有功能**:
- [ ] 商品瀏覽和下單
- [ ] 購物車功能
- [ ] LINE圖文選單整合
- [ ] 營業時間控制
- [ ] 價格變動確認機制

**缺失功能**:
- [ ] 商品搜尋功能 (需新增)

**不需要的功能**:
- ❌ 用戶註冊 (透過LINE進入)
- ❌ 用戶個人中心 (暫不需要)
- ❌ 訂單歷史查詢 (已有其他機制)

### 🏢 後台管理系統
**已有功能**:
- [ ] 管理員登入認證
- [ ] 訂單管理
- [ ] 商品管理
- [ ] 庫存管理
- [ ] 價格更新系統
- [ ] 營業時間設定
- [ ] LINE通知管理

**需完善功能**:
- [ ] 客戶管理 (姓名、地址、電話、訂購次數、歷史訂單)
- [ ] 財務報表 (實用為主，不華而不實)
- [ ] 營運分析工具 (實用為主，不華而不實)

### 🚛 外送員系統 (PWA)
**已有功能**:
- [ ] PWA離線應用
- [ ] 外送員登入
- [ ] 訂單接單系統
- [ ] Google Maps自動導航
- [ ] 智能配送流程
- [ ] GPS追蹤整合
- [ ] 配送統計

**配送流程**:
1. 打開PWA查看待配送訂單
2. 點擊「確認取貨」→「開始配送」
3. 自動開啟Google Maps導航
4. 點擊「完成配送」
5. 🚀 自動開啟下一訂單導航
6. 全部完成後自動導航回配送中心

## 🔄 訂單狀態流程與價格確認機制

### 正確的訂單狀態流程
```
1. 客戶下單 → "待確認" (pending) - 等待每日價格確認
2. 價格確認完成 → "準備中" (preparing) - 開始備貨
3. 包裝完成 → "包裝完成" (packed) - 後台包裝員點擊
4. 外送員接單 → "配送中" (delivering) - 外送員接單
5. 配送完成 → "已完成" (delivered) - 外送員完成
6. 客戶取消 → "已取消" (cancelled) - 後台設定或客戶取消
```

### 💰 每日價格確認機制
```
每日7:30自動更新商品價格
↓
系統比對價格變動 (閾值15%)
↓
超過閾值 → LINE自動通知客戶
↓
客戶30分鐘內回前台「訂單查詢」確認
├── 確認保留 → 進入"準備中"
└── 逾時未回應 → 強制接受 → 進入"準備中"
```

### 當前狀態定義問題
**後台使用**: ['placed', 'confirmed', 'preparing', 'out_for_delivery', 'delivered']
**外送端期望**: ['pending', 'confirmed', 'preparing', 'packed', 'delivering']
**需要統一為上述正確流程**

## 🛠️ 技術架構

### 核心技術棧
- **後端**: Node.js + Express
- **資料庫**: PostgreSQL (Railway)
- **前端**: EJS模板 + vanilla JavaScript
- **外送員端**: PWA (Progressive Web App)
- **通知系統**: LINE Bot API
- **地圖服務**: Google Maps API

### 重要服務模組
- **PriceChangeNotificationService**: 價格變動通知
- **LineNotificationService**: LINE通知服務
- **BasicSettingsService**: 系統設定管理
- **SmartRouteService**: 智能路線規劃
- **RouteOptimizationService**: 路線優化

## ⚠️ 已知問題

### 🔴 需要立即修復
1. **訂單狀態同步不一致** - 三端狀態定義不同
2. **demoMode系統複雜化** - 建議刪除或簡化

### 🟡 功能增強需求
1. **前台商品搜尋** - 提升用戶體驗
2. **後台客戶管理** - 完善客戶資料檢視
3. **實用報表系統** - 支援營運決策

## 🚨 修改前必讀檢查清單

在修改任何代碼前，請確認：
- [ ] 我完全理解要修改的功能模組
- [ ] 我了解此功能與其他系統的依賴關係
- [ ] 我確認修改不會破壞現有正常運作的功能
- [ ] 我有測試計劃和回滾方案
- [ ] 我已經備份相關文件

## 📋 系統整體評估

**系統成熟度**: 75% (核心商業邏輯完整)
**商業就緒度**: 修復關鍵問題後可達85%
**主要優勢**: 完整的三端架構，智能化配送流程
**核心問題**: 狀態同步和功能完整性

---

**⚠️ 重要提醒：這個系統已經有很多正常運作的功能，請謹慎修改！**