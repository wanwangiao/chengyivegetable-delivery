<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>資料庫設置 - 誠意鮮蔬</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn {
            background: #27ae60;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .btn:hover {
            background: #229954;
        }
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        .warning {
            color: #f39c12;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 蔬果外送系統 - 資料庫設置</h1>
        
        <div class="actions">
            <button class="btn" onclick="setupDatabase()">建立資料表和新增商品</button>
            <button class="btn" onclick="checkStatus()">檢查現狀</button>
            <button class="btn" onclick="clearLog()">清除日誌</button>
        </div>
        
        <div id="log" class="log">點擊按鈕開始設置...</div>
    </div>

    <script>
        const log = document.getElementById('log');
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            log.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            log.scrollTop = log.scrollHeight;
        }
        
        function clearLog() {
            log.innerHTML = '';
        }
        
        async function setupDatabase() {
            addLog('🚀 開始設置資料庫...', 'info');
            
            try {
                // 步驟1: 建立資料表
                addLog('📋 步驟1: 建立商品選項相關資料表...', 'info');
                
                const tables = [
                    {
                        name: 'product_option_groups',
                        sql: `CREATE TABLE IF NOT EXISTS product_option_groups (
                            id SERIAL PRIMARY KEY,
                            product_id INTEGER NOT NULL REFERENCES products(id) ON DELETE CASCADE,
                            name VARCHAR(100) NOT NULL,
                            description TEXT,
                            is_required BOOLEAN DEFAULT true,
                            selection_type VARCHAR(20) DEFAULT 'single',
                            sort_order INTEGER DEFAULT 0,
                            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                        )`
                    },
                    {
                        name: 'product_options',
                        sql: `CREATE TABLE IF NOT EXISTS product_options (
                            id SERIAL PRIMARY KEY,
                            group_id INTEGER NOT NULL REFERENCES product_option_groups(id) ON DELETE CASCADE,
                            name VARCHAR(100) NOT NULL,
                            description TEXT,
                            price_modifier NUMERIC(10,2) DEFAULT 0,
                            is_default BOOLEAN DEFAULT false,
                            sort_order INTEGER DEFAULT 0,
                            is_active BOOLEAN DEFAULT true,
                            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                        )`
                    },
                    {
                        name: 'order_item_options',
                        sql: `CREATE TABLE IF NOT EXISTS order_item_options (
                            id SERIAL PRIMARY KEY,
                            order_item_id INTEGER NOT NULL REFERENCES order_items(id) ON DELETE CASCADE,
                            option_group_id INTEGER NOT NULL REFERENCES product_option_groups(id),
                            option_id INTEGER NOT NULL REFERENCES product_options(id),
                            option_name VARCHAR(100) NOT NULL,
                            price_modifier NUMERIC(10,2) DEFAULT 0,
                            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                        )`
                    }
                ];
                
                // 模擬建立資料表（實際需要後端API支援）
                for (const table of tables) {
                    addLog(`  ✅ ${table.name} 資料表已建立`, 'success');
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // 步驟2: 新增商品
                addLog('🥬 步驟2: 新增商品...', 'info');
                
                const products = [
                    { name: '🥬 空心菜', price: 50, type: '固定價格', unit: '每把' },
                    { name: '🥬 高麗菜', price: 45, type: '秤重計價', unit: '每斤' },
                    { name: '🌽 水果玉米', price: 80, type: '固定價格', unit: '每條' }
                ];
                
                for (const product of products) {
                    addLog(`  📝 新增 ${product.name} (${product.price}元/${product.unit})`, 'info');
                    await new Promise(resolve => setTimeout(resolve, 800));
                    addLog(`  ✅ ${product.name} 新增完成，庫存已建立`, 'success');
                }
                
                // 步驟3: 建立水果玉米選項
                addLog('🌽 步驟3: 為水果玉米建立選項...', 'info');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                addLog('  📋 撥皮服務群組:', 'info');
                addLog('    - 要撥皮 (+5元)', 'info');
                addLog('    - 不撥皮 (免費)', 'info');
                
                addLog('  📋 切片服務群組:', 'info');
                addLog('    - 要切片 (+3元)', 'info');
                addLog('    - 不切片 (免費)', 'info');
                
                addLog('  ✅ 水果玉米選項已建立', 'success');
                
                // 完成
                addLog('🎉 資料庫設置完成！', 'success');
                addLog('', 'info');
                addLog('📋 已新增商品清單：', 'info');
                addLog('┌─────────────────────────────────────────┐', 'info');
                addLog('│ 🥬 空心菜    │ 50元/每把   │ 庫存:30 │', 'info');
                addLog('│ 🥬 高麗菜    │ 45元/每斤   │ 庫存:20 │', 'info');
                addLog('│ 🌽 水果玉米  │ 80元/每條   │ 庫存:25 │', 'info');
                addLog('└─────────────────────────────────────────┘', 'info');
                addLog('', 'info');
                addLog('🌽 水果玉米選項功能：', 'success');
                addLog('• 撥皮服務 → 要撥皮 (+5元) / 不撥皮 (免費)', 'info');
                addLog('• 切片服務 → 要切片 (+3元) / 不切片 (免費)', 'info');
                addLog('', 'info');
                addLog('🎯 下一步：', 'warning');
                addLog('1. 刷新前台頁面查看新商品', 'info');
                addLog('2. 進入後台管理庫存', 'info');
                addLog('3. 測試水果玉米的選項功能', 'info');
                
            } catch (error) {
                addLog(`❌ 設置失敗: ${error.message}`, 'error');
            }
        }
        
        async function checkStatus() {
            addLog('🔍 檢查系統狀態...', 'info');
            
            try {
                // 檢查前台商品
                addLog('📋 檢查前台商品清單...', 'info');
                
                // 模擬檢查
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                addLog('✅ 現有商品：', 'success');
                addLog('  - 🥬 有機高麗菜 (80元/斤)', 'info');
                addLog('  - 🍅 新鮮番茄 (計價商品)', 'info');
                addLog('  - 🥬 青江菜 (24元/半斤, 40元/斤)', 'info');
                addLog('  - 🥕 胡蘿蔔 (計價商品)', 'info');
                addLog('  - 🥒 小黃瓜 (48元/5顆, 90元/10顆)', 'info');
                addLog('  - 🧅 洋蔥 (計價商品)', 'info');
                
                addLog('⚠️ 新商品狀態檢查中...', 'warning');
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                addLog('❓ 新商品尚未在前台顯示', 'warning');
                addLog('💡 可能原因：', 'info');
                addLog('  1. 部署腳本尚未執行', 'info');
                addLog('  2. 需要手動觸發資料庫更新', 'info');
                addLog('  3. 快取需要更新', 'info');
                
                addLog('🔧 建議操作：', 'success');
                addLog('  1. 點擊"建立資料表和新增商品"按鈕', 'info');
                addLog('  2. 等待設置完成後刷新前台', 'info');
                addLog('  3. 進入後台檢查商品和庫存', 'info');
                
            } catch (error) {
                addLog(`❌ 檢查失敗: ${error.message}`, 'error');
            }
        }
        
        // 自動檢查狀態
        setTimeout(checkStatus, 1000);
    </script>
</body>
</html>