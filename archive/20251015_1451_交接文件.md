# 🚀 誠憶鮮蔬系統 - 購物車功能交接文件

**交接日期**: 2025年10月15日 14:51
**交接人**: AI Development Agent
**接收人**: 下一位開發人員

---

## 📋 目錄

1. [已完成工作](#已完成工作)
2. [立即待辦事項](#立即待辦事項)
3. [快速啟動指南](#快速啟動指南)
4. [測試清單](#測試清單)
5. [詳細任務列表](#詳細任務列表)
6. [專案結構](#專案結構)
7. [常見問題](#常見問題)

---

## ✅ 已完成工作

### 購物車系統 (P0 - 100%完成)

已建立並整合完整的彈窗式購物車系統:

#### 新建檔案 (4個組件)
- ✅ `apps/web/src/hooks/useCart.ts` (158行) - 購物車狀態管理
- ✅ `apps/web/src/components/FloatingCartBar.tsx` (86行) - 浮動購物車按鈕
- ✅ `apps/web/src/components/CartDrawer.tsx` (203行) - 購物車抽屜
- ✅ `apps/web/src/components/CheckoutDrawer.tsx` (262行) - 結帳抽屜

#### 修改檔案
- ✅ `apps/web/src/app/page.tsx` (310行) - 已完整整合購物車功能

#### 功能特性
- ✅ 浮動購物車卡片 (四周留白16px，圓角陰影)
- ✅ 響應式抽屜 (手機底部70vh / 桌面右側450px)
- ✅ 數量調整 `[-] [數字] [+]` 按鈕
- ✅ 免運進度條 (滿 NT$200 免運費)
- ✅ 結帳抽屜與購物車相同大小
- ✅ 折疊式訂單摘要
- ✅ 自動載入上次客戶資料
- ✅ localStorage 購物車持久化
- ✅ 完整的結帳流程 (購物車 → 結帳 → 訂單追蹤)

---

## ⚠️ 立即待辦事項

### 🔴 緊急 (今日或明日完成)

#### 1. 測試購物車功能 (0.5小時)
```bash
cd /c/chengyivegetable
pnpm dev
# 訪問 http://localhost:3001
```

**測試項目**:
- [ ] 點擊「加入購物車」按鈕
- [ ] 確認浮動卡片顯示正確
- [ ] 點擊卡片打開購物車抽屜
- [ ] 測試增加/減少數量
- [ ] 測試刪除商品
- [ ] 測試免運進度條
- [ ] 點擊「前往結帳」
- [ ] 填寫表單並提交訂單
- [ ] 確認跳轉至訂單追蹤頁面

#### 2. 後端價格驗證 (2小時) - P0 安全問題
**檔案**: `apps/api/src/domain/order-service.ts`

**需要加入的代碼**:
- 在訂單建立時驗證前端傳來的價格與資料庫價格是否一致
- 允許 ±0.01 的浮點數誤差
- 價格不符時拋出錯誤

#### 3. 後端庫存扣減 (4小時) - P0 安全問題
**檔案**: `apps/api/src/domain/order-service.ts`

**需要實作**:
- 使用 Prisma transaction 確保原子性
- 訂單建立時檢查並扣減庫存
- 庫存不足時拋出錯誤
- 訂單取消時恢復庫存

### 🟠 本週完成 (2025-10-16~19)

4. **資料庫備份設定** (0.5天)
   - Railway 後台設定自動備份
   - 每日備份，保留7天

5. **Sentry 錯誤監控** (0.5天)
   - 註冊並配置 Sentry
   - 安裝套件並測試

6. **API 速率限制** (0.5天)
   - 安裝 express-rate-limit
   - 設定全域和登入限制

7. **移除舊結帳頁面** (0.1天)
   - 備份並移除 `src/app/checkout`

---

## 🚀 快速啟動指南

### 步驟 1: 檢查檔案
```bash
cd /c/chengyivegetable/apps/web/src

# 確認檔案存在
ls -la hooks/useCart.ts
ls -la components/FloatingCartBar.tsx
ls -la components/CartDrawer.tsx
ls -la components/CheckoutDrawer.tsx
ls -la app/page.tsx
```

### 步驟 2: 安裝依賴
```bash
cd /c/chengyivegetable
pnpm install
```

### 步驟 3: 啟動開發伺服器
```bash
# 同時啟動 API + Web
pnpm dev
```

預期輸出:
```
@chengyi/web:dev: ▲ Next.js 14.x.x
@chengyi/web:dev: - Local:        http://localhost:3001
@chengyi/web:dev: ✓ Ready in 2.5s
```

### 步驟 4: 測試功能
1. 開啟 http://localhost:3001
2. 點擊任一商品「加入購物車」
3. 確認浮動卡片出現
4. 測試購物車和結帳流程

---

## ✅ 測試清單

### 基本功能測試

**加入購物車**:
- [ ] 點擊「加入購物車」出現提示
- [ ] 浮動卡片顯示正確數量和金額
- [ ] 卡片位於底部，四周有留白

**購物車抽屜**:
- [ ] 點擊卡片打開抽屜
- [ ] 顯示所有商品清單
- [ ] `[+]` 增加數量正常
- [ ] `[-]` 減少數量正常 (最少為1)
- [ ] `🗑️` 刪除商品正常
- [ ] 小計 < NT$200 時顯示運費 NT$60
- [ ] 小計 ≥ NT$200 時運費為 NT$0
- [ ] 免運進度條正確顯示

**結帳流程**:
- [ ] 點擊「前往結帳」打開結帳抽屜
- [ ] 抽屜大小與購物車相同
- [ ] 表單必填欄位驗證正常
- [ ] 訂單摘要可展開/收起
- [ ] 點擊「← 返回購物車」可返回
- [ ] 填寫完整資料後可提交
- [ ] 提交成功後跳轉至訂單追蹤頁
- [ ] 購物車清空
- [ ] 客戶資料保存 (下次自動載入)

### 響應式測試

**手機版** (寬度 < 600px):
- [ ] 抽屜從底部滑入，高度為 70vh

**桌面版** (寬度 ≥ 600px):
- [ ] 抽屜從右側滑入，寬度為 450px

---

## 📋 詳細任務列表

### P0 - 阻塞問題 (14% 完成)

| 任務 | 預計時間 | 狀態 |
|------|---------|------|
| 購物車UI實作 | - | ✅ 完成 |
| 購物車測試 | 0.5小時 | ⏳ 待處理 |
| 價格驗證 | 2小時 | ⏳ 待處理 |
| 庫存扣減 | 4小時 | ⏳ 待處理 |
| 資料庫備份 | 0.5天 | ⏳ 待處理 |
| Sentry整合 | 0.5天 | ⏳ 待處理 |
| 速率限制 | 0.5天 | ⏳ 待處理 |

### P1 - 高優先級 (0% 完成)

1. LINE LIFF 綁定流程 (2天)
2. Driver App 即時通訊 (2天)
3. CI/CD 增強 (1天)
4. 環境變數驗證 (0.5天)
5. Docker 多階段構建 (1天)

### P2 - 中優先級 (0% 完成)

1. 支付流程整合 (LINE Pay)
2. 報表統計功能
3. 會員等級系統
4. 商品評價功能
5. 優惠券系統

---

## 📂 專案結構

```
/c/chengyivegetable/
├── apps/web/src/
│   ├── hooks/
│   │   └── useCart.ts              ✅ 新建
│   ├── components/
│   │   ├── FloatingCartBar.tsx    ✅ 新建
│   │   ├── CartDrawer.tsx         ✅ 新建
│   │   └── CheckoutDrawer.tsx     ✅ 新建
│   └── app/
│       └── page.tsx                ✅ 已更新
│
├── apps/api/src/domain/
│   └── order-service.ts            ⚠️ 待更新
│
└── 2025年10月15日_14時51分_交接文件.md  ← 本檔案
```

### 技術棧

**前端**: Next.js 14, Material-UI v6, TypeScript
**後端**: Express.js, Prisma, PostgreSQL

---

## 🔧 常見問題

### 問題 1: 模組找不到
```bash
cd /c/chengyivegetable
rm -rf node_modules
pnpm install
```

### 問題 2: TypeScript 錯誤
```bash
pnpm --filter web tsc --noEmit
```

### 問題 3: 購物車不顯示
- 檢查瀏覽器 Console
- 確認 localStorage 權限
- 清除瀏覽器快取

### 問題 4: 提交訂單失敗
- 確認後端 API 已啟動
- 檢查網路請求 (開發者工具)

---

## 🎯 關鍵提醒

### ⚠️ 安全問題 (必須立即處理)
1. **價格驗證**: 前端可竄改價格
2. **庫存扣減**: 不會扣減庫存,可能超賣
3. **速率限制**: 無 API 限制

### 🎨 設計決策
- 浮動卡片四周留白 16px
- 免運門檻: NT$200
- 運費: NT$60

---

## ✨ 總結

### 本次交付
✅ 4 個新組件
✅ 首頁完整整合
✅ 完整購物流程
✅ 響應式設計

### 下一步
1. 🔴 測試購物車 (0.5h)
2. 🔴 價格驗證 (2h)
3. 🔴 庫存扣減 (4h)

---

**交接狀態**: ✅ 100% 完成
**預估上手時間**: 15 分鐘

**最後更新**: 2025年10月15日 14:51
