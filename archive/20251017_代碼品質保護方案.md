# 代碼品質保護方案

**建立日期**: 2025-10-17
**目的**: 防止代碼損壞和語法錯誤進入版本庫
**優先級**: 🔴 高 - 立即實施

---

## 🎯 目標

1. **100% 防止語法錯誤提交**
2. **自動化檢查流程**
3. **提升代碼品質**
4. **加快問題發現速度**

---

## 📋 實施計畫 (分階段)

### 階段 1: 立即實施 (今天,30分鐘)
- ✅ Git hooks (Husky + lint-staged)
- ✅ TypeScript 編譯檢查
- ✅ ESLint 基礎規則

### 階段 2: 本週完成 (2-3小時)
- GitHub Actions CI/CD
- 自動化測試
- Pull Request 保護規則

### 階段 3: 持續改進 (長期)
- 增加測試覆蓋率
- 代碼審查流程
- 監控和告警

---

## 🔧 階段 1: Git Hooks 設定

### 1.1 安裝必要套件

```bash
cd C:\chengyivegetable

# 安裝 Husky (Git hooks 管理工具)
pnpm add -D husky

# 安裝 lint-staged (只檢查 staged 檔案)
pnpm add -D lint-staged

# 初始化 Husky
npx husky init
```

### 1.2 建立 pre-commit hook

創建檔案: `.husky/pre-commit`

```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🔍 Running pre-commit checks..."

# 運行 lint-staged
npx lint-staged

# 檢查是否有語法錯誤
echo "📝 Checking TypeScript syntax..."
pnpm run type-check

echo "✅ All checks passed!"
```

**Windows 用戶注意**: 在 Git Bash 中執行:
```bash
chmod +x .husky/pre-commit
```

### 1.3 配置 lint-staged

在 `package.json` 添加:

```json
{
  "lint-staged": {
    "*.{ts,tsx}": [
      "eslint --fix",
      "prettier --write"
    ],
    "apps/*/src/**/*.{ts,tsx}": [
      "bash -c 'pnpm run type-check'"
    ]
  }
}
```

### 1.4 添加 TypeScript 檢查腳本

在根目錄 `package.json` 添加:

```json
{
  "scripts": {
    "type-check": "pnpm -r run type-check",
    "type-check:api": "cd apps/api && tsc --noEmit",
    "type-check:web": "cd apps/web && tsc --noEmit",
    "type-check:driver": "cd apps/driver && tsc --noEmit",
    "lint": "eslint . --ext .ts,.tsx --max-warnings 0",
    "lint:fix": "eslint . --ext .ts,.tsx --fix",
    "format": "prettier --write \"**/*.{ts,tsx,js,jsx,json,md}\"",
    "format:check": "prettier --check \"**/*.{ts,tsx,js,jsx,json,md}\""
  }
}
```

### 1.5 建立 commit-msg hook (可選)

創建檔案: `.husky/commit-msg`

```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# 檢查 commit message 格式
npx --no -- commitlint --edit "$1"
```

安裝 commitlint:
```bash
pnpm add -D @commitlint/cli @commitlint/config-conventional
```

創建 `commitlint.config.js`:
```javascript
module.exports = {
  extends: ['@commitlint/config-conventional'],
  rules: {
    'type-enum': [
      2,
      'always',
      [
        'feat',     // 新功能
        'fix',      // 修復 bug
        'docs',     // 文件更新
        'style',    // 格式調整
        'refactor', // 重構
        'perf',     // 性能優化
        'test',     // 測試
        'chore',    // 雜項
        'revert'    // 回退
      ]
    ]
  }
};
```

---

## 🚀 階段 2: GitHub Actions CI/CD

### 2.1 建立 CI workflow

創建檔案: `.github/workflows/ci.yml`

```yaml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-type-check:
    name: Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run ESLint
        run: pnpm run lint

      - name: Run TypeScript check
        run: pnpm run type-check

      - name: Run Prettier check
        run: pnpm run format:check

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint-and-type-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run tests
        run: pnpm run test
        env:
          CI: true

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: lint-and-type-check

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build API
        run: pnpm --filter @chengyi/api build

      - name: Build Web
        run: pnpm --filter @chengyi/web build
        env:
          NEXT_PUBLIC_API_BASE: https://chengyivegetable-api-production.up.railway.app/api/v1

      - name: Build Driver
        run: pnpm --filter @chengyi/driver build
```

### 2.2 建立 Pull Request 檢查

創建檔案: `.github/workflows/pr-checks.yml`

```yaml
name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  check-files:
    name: Check Changed Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            apps/**/*.{ts,tsx}
            packages/**/*.{ts,tsx}

      - name: Check for syntax errors in changed files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "Checking changed TypeScript files..."
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Checking $file"
            npx tsc --noEmit "$file" || exit 1
          done

  pr-size-check:
    name: PR Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            if (pr.additions + pr.deletions > 1000) {
              core.setFailed('❌ PR太大了！請拆分成較小的PR (目前: ' + (pr.additions + pr.deletions) + ' 行)');
            }
```

### 2.3 設定 Branch Protection Rules

在 GitHub Repository → Settings → Branches:

```yaml
Branch name pattern: main

Require a pull request before merging:
  ✅ Require approvals: 1
  ✅ Dismiss stale pull request approvals when new commits are pushed
  ✅ Require review from Code Owners

Require status checks to pass before merging:
  ✅ Require branches to be up to date before merging
  ✅ Status checks that are required:
      - lint-and-type-check
      - test
      - build
      - check-files

Require conversation resolution before merging: ✅

Do not allow bypassing the above settings: ✅
```

---

## 🔍 階段 3: 編輯器配置

### 3.1 VS Code 設定

創建 `.vscode/settings.json`:

```json
{
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true,
    "source.organizeImports": true
  },
  "typescript.tsdk": "node_modules/typescript/lib",
  "typescript.enablePromptUseWorkspaceTsdk": true,
  "files.eol": "\n",
  "files.insertFinalNewline": true,
  "files.trimTrailingWhitespace": true,
  "[typescript]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[typescriptreact]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  }
}
```

創建 `.vscode/extensions.json`:

```json
{
  "recommendations": [
    "esbenp.prettier-vscode",
    "dbaeumer.vscode-eslint",
    "ms-vscode.vscode-typescript-next",
    "streetsidesoftware.code-spell-checker",
    "usernamehw.errorlens"
  ]
}
```

### 3.2 EditorConfig

創建 `.editorconfig`:

```ini
root = true

[*]
charset = utf-8
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true
indent_style = space
indent_size = 2

[*.md]
trim_trailing_whitespace = false

[*.{yml,yaml}]
indent_size = 2

[Makefile]
indent_style = tab
```

### 3.3 Prettier 配置

創建 `.prettierrc.json`:

```json
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 100,
  "arrowParens": "avoid",
  "endOfLine": "lf"
}
```

創建 `.prettierignore`:

```
node_modules
dist
build
.next
.railway
coverage
pnpm-lock.yaml
*.log
```

---

## 🧪 階段 4: 測試策略

### 4.1 單元測試配置

在各個 app 的 `package.json` 添加:

```json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage"
  },
  "devDependencies": {
    "@vitest/ui": "^1.0.0",
    "vitest": "^1.0.0",
    "@testing-library/react": "^14.0.0",
    "@testing-library/jest-dom": "^6.0.0"
  }
}
```

創建 `vitest.config.ts`:

```typescript
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./src/test/setup.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'json', 'html'],
      exclude: [
        'node_modules/',
        'src/test/',
        '**/*.d.ts',
        '**/*.config.*',
        '**/mockData/'
      ]
    }
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src')
    }
  }
});
```

### 4.2 關鍵功能測試清單

| 功能 | 測試類型 | 優先級 |
|------|---------|--------|
| 訂單建立 | 單元測試 + 整合測試 | 🔴 高 |
| 價格驗證 | 單元測試 | 🔴 高 |
| 庫存扣減 | 單元測試 + 整合測試 | 🔴 高 |
| LINE 自動綁定 | 整合測試 | 🔴 高 |
| 外送員導航 | E2E 測試 | 🟡 中 |
| 地圖路線計算 | 單元測試 | 🟡 中 |

---

## 📊 監控和告警

### 5.1 Sentry 整合 (已完成)

✅ 已在 `apps/api/src/config/sentry.ts` 整合

**待設定**: `SENTRY_DSN` 環境變數

### 5.2 錯誤追蹤 Dashboard

建議監控指標:
- TypeScript 編譯錯誤數量
- ESLint 警告數量
- 測試失敗率
- 部署成功率
- API 錯誤率

---

## 🔄 開發工作流程改進

### 最佳實踐:

1. **開發新功能**
   ```bash
   # 1. 創建新分支
   git checkout -b feature/新功能名稱

   # 2. 開發並經常提交
   git add .
   git commit -m "feat: 新功能描述"
   # (pre-commit hook 自動檢查)

   # 3. 推送前先拉取最新代碼
   git pull origin main --rebase

   # 4. 推送到遠端
   git push origin feature/新功能名稱

   # 5. 建立 Pull Request
   # (GitHub Actions 自動檢查)
   ```

2. **修復 Bug**
   ```bash
   git checkout -b fix/bug描述
   # ... 修復 ...
   git commit -m "fix: bug描述"
   ```

3. **重構代碼**
   ```bash
   git checkout -b refactor/重構描述
   # ... 重構 ...
   git commit -m "refactor: 重構描述"
   ```

### Commit Message 規範:

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type**:
- `feat`: 新功能
- `fix`: 修復 bug
- `docs`: 文件更新
- `style`: 格式調整
- `refactor`: 重構
- `test`: 測試
- `chore`: 雜項

**範例**:
```
feat(driver): add offline queue for network errors

- Implement IndexedDB-based queue
- Auto-retry on network recovery
- Show queue status in UI

Closes #123
```

---

## 📋 實施檢查清單

### 立即執行 (今天):

- [ ] 安裝 Husky 和 lint-staged
- [ ] 建立 pre-commit hook
- [ ] 添加 type-check 腳本
- [ ] 配置 ESLint 規則
- [ ] 測試 Git hook 是否正常運作

### 本週執行:

- [ ] 建立 GitHub Actions workflow
- [ ] 設定 Branch Protection Rules
- [ ] 配置 VS Code 設定
- [ ] 建立 .editorconfig
- [ ] 添加 Prettier 配置
- [ ] 通知團隊新的開發流程

### 持續執行:

- [ ] 監控 CI/CD 執行結果
- [ ] 定期檢查代碼品質指標
- [ ] 更新測試覆蓋率
- [ ] 代碼審查
- [ ] 團隊培訓

---

## 🎓 團隊培訓

### 培訓主題:

1. **Git Hooks 使用** (30分鐘)
   - 什麼是 pre-commit hook
   - 如何略過 hook (不建議)
   - 如何修復 hook 失敗

2. **Commit Message 規範** (15分鐘)
   - Conventional Commits
   - 好的 commit message 範例

3. **Pull Request 流程** (30分鐘)
   - 如何建立 PR
   - 如何回應 review comments
   - 如何修復 CI 失敗

4. **代碼審查技巧** (45分鐘)
   - 審查重點
   - 如何給建設性意見
   - 常見問題處理

---

## 💡 常見問題

### Q1: Git hook 太慢怎麼辦?

**A**: 使用 lint-staged 只檢查修改的文件:
```bash
# 只檢查 staged 文件,不是整個專案
npx lint-staged
```

### Q2: 緊急修復如何略過檢查?

**A**: 只在極緊急情況使用:
```bash
git commit --no-verify -m "fix: 緊急修復"
```
**注意**: CI 仍會檢查,如果失敗會阻止合併。

### Q3: CI 失敗但本地沒問題?

**A**: 可能原因:
1. 本地沒有更新依賴
2. 環境變數不同
3. Node.js 版本不同

解決方法:
```bash
# 清除快取並重新安裝
rm -rf node_modules
pnpm install --frozen-lockfile

# 確保 Node 版本一致
node --version  # 應該是 20.x
```

### Q4: 如何暫時停用 hook?

**A**:
```bash
# 停用 Husky (不建議)
pnpm run husky uninstall

# 重新啟用
pnpm run husky install
```

---

## 📈 預期效果

### 實施前:
- ❌ 語法錯誤可以被提交
- ❌ 沒有自動化檢查
- ❌ 問題在部署後才發現
- ❌ 花費大量時間除錯

### 實施後:
- ✅ 100% 防止語法錯誤提交
- ✅ 自動化檢查 (< 2分鐘)
- ✅ 問題在提交前發現
- ✅ 節省 80% 除錯時間

### 投資回報率 (ROI):

| 項目 | 投入 | 節省 | ROI |
|------|------|------|-----|
| 設定時間 | 3 小時 | - | - |
| 每次提交時間 | +30秒 | -15分鐘除錯 | 30x |
| CI/CD 維護 | 1小時/月 | -8小時/月除錯 | 8x |

---

## 🚀 開始實施

### 第一步: 安裝 Git Hooks

```bash
cd C:\chengyivegetable

# 安裝套件
pnpm add -D husky lint-staged @commitlint/cli @commitlint/config-conventional

# 初始化 Husky
npx husky init

# 建立 pre-commit hook
cat > .husky/pre-commit << 'EOF'
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🔍 Running pre-commit checks..."
npx lint-staged
pnpm run type-check
echo "✅ All checks passed!"
EOF

# 給予執行權限
chmod +x .husky/pre-commit

# 測試
git add .
git commit -m "test: testing git hooks"
```

---

**下一步**: 請確認是否要我幫您**立即實施階段 1 (Git Hooks)**? 🚀

我可以幫您:
1. 安裝所有必要套件
2. 建立 hook 檔案
3. 配置 lint-staged
4. 測試是否正常運作

只需回覆「開始實施」即可! ✅
