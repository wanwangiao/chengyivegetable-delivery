# 🎯 誠憶鮮蔬系統 - 完整待辦事項清單

> **更新時間**: 2025-10-15 23:10
> **當前版本**: v0.5.0
> **部署狀態**: ✅ 已完成（待驗證與優化）

---

## 📋 目錄

1. [🔴 P0 - 緊急阻塞問題](#p0---緊急阻塞問題)
2. [🟠 P1 - 高優先級](#p1---高優先級)
3. [🟡 P2 - 中優先級](#p2---中優先級)
4. [🟢 P3 - 低優先級](#p3---低優先級)
5. [📊 進度追蹤](#進度追蹤)
6. [⏰ 時間估算](#時間估算)

---

## 🔴 P0 - 緊急阻塞問題

> **必須在正式營運前完成**
> **預估總時間**: 13.5 小時 / 2 工作日

### 1. 購物車安全性修正 (6.5 小時)

#### 1.1 後端價格驗證 ⭐⭐⭐ (2 小時)
**檔案**: `apps/api/src/domain/order-service.ts`

**現況問題**:
- ❌ 前端可以竄改商品價格
- ❌ 前端可以竄改運費金額
- ❌ 沒有驗證訂單總金額

**需要實作**:
```typescript
// apps/api/src/domain/order-service.ts

async validateOrderPrices(orderItems: OrderItem[]): Promise<boolean> {
  for (const item of orderItems) {
    // 從資料庫查詢當前商品價格
    const product = await this.productRepository.findById(item.productId);

    // 驗證價格（允許 ±0.01 浮點數誤差）
    const priceDiff = Math.abs(product.price - item.unitPrice);
    if (priceDiff > 0.01) {
      throw new Error(
        `PRICE_MISMATCH: Product ${product.name} price changed. ` +
        `Expected: ${product.price}, Got: ${item.unitPrice}`
      );
    }
  }

  return true;
}

// 在 create() 方法中加入驗證
async create(input: Omit<Order, 'id' | 'status'>): Promise<Order> {
  // 驗證價格
  await this.validateOrderPrices(input.items);

  // 驗證運費計算
  const subtotal = input.items.reduce((sum, item) =>
    sum + (item.unitPrice * item.quantity), 0
  );

  const expectedDeliveryFee = subtotal >= 200 ? 0 : 60;
  if (Math.abs(input.deliveryFee - expectedDeliveryFee) > 0.01) {
    throw new Error('DELIVERY_FEE_MISMATCH');
  }

  // 繼續原有邏輯...
}
```

**測試驗證**:
- [ ] 前端竄改價格，後端拋出 `PRICE_MISMATCH` 錯誤
- [ ] 前端竄改運費，後端拋出 `DELIVERY_FEE_MISMATCH` 錯誤
- [ ] 正常訂單可以成功建立

---

#### 1.2 後端庫存扣減 ⭐⭐⭐ (4 小時)
**檔案**: `apps/api/src/domain/order-service.ts`

**現況問題**:
- ❌ 訂單建立不會扣減庫存
- ❌ 可能發生超賣（庫存為 0 仍可下單）
- ❌ 訂單取消不會恢復庫存

**需要實作**:
```typescript
// apps/api/src/domain/order-service.ts

async createOrderWithInventory(
  input: Omit<Order, 'id' | 'status'>
): Promise<Order> {
  // 使用 Prisma transaction 確保原子性
  return await prisma.$transaction(async (tx) => {
    // 1. 檢查並鎖定庫存
    for (const item of input.items) {
      const product = await tx.product.findUnique({
        where: { id: item.productId },
        select: { stock: true, name: true }
      });

      if (!product) {
        throw new Error(`PRODUCT_NOT_FOUND: ${item.productId}`);
      }

      if (product.stock < item.quantity) {
        throw new Error(
          `INSUFFICIENT_STOCK: ${product.name} ` +
          `(available: ${product.stock}, requested: ${item.quantity})`
        );
      }

      // 2. 扣減庫存
      await tx.product.update({
        where: { id: item.productId },
        data: {
          stock: {
            decrement: item.quantity
          }
        }
      });
    }

    // 3. 建立訂單
    const order = await tx.order.create({
      data: { ...orderData }
    });

    return order;
  });
}

// 訂單取消恢復庫存
async cancelOrderAndRestoreInventory(orderId: string): Promise<Order> {
  return await prisma.$transaction(async (tx) => {
    const order = await tx.order.findUnique({
      where: { id: orderId },
      include: { items: true }
    });

    // 恢復庫存
    for (const item of order.items) {
      await tx.product.update({
        where: { id: item.productId },
        data: {
          stock: {
            increment: item.quantity
          }
        }
      });
    }

    // 更新訂單狀態
    return await tx.order.update({
      where: { id: orderId },
      data: { status: 'cancelled' }
    });
  });
}
```

**測試驗證**:
- [ ] 建立訂單後，商品庫存正確減少
- [ ] 庫存不足時，拋出 `INSUFFICIENT_STOCK` 錯誤
- [ ] 訂單取消後，庫存正確恢復
- [ ] Transaction 失敗時，庫存不會被扣減

---

#### 1.3 購物車功能測試 ⭐⭐ (0.5 小時)
**執行步驟**:
```bash
cd /c/chengyivegetable
pnpm dev
# 訪問 http://localhost:3001
```

**測試清單**:
- [ ] 加入購物車顯示浮動卡片
- [ ] 卡片四周有 16px 留白
- [ ] 點擊卡片打開購物車抽屜
- [ ] `[+]` 增加數量正常
- [ ] `[-]` 減少數量正常（最少為 1）
- [ ] `🗑️` 刪除商品正常
- [ ] 小計 < NT$200 時運費 = NT$60
- [ ] 小計 ≥ NT$200 時運費 = NT$0
- [ ] 免運進度條正確顯示
- [ ] 點擊「前往結帳」打開結帳抽屜
- [ ] 表單必填驗證正常
- [ ] 訂單摘要可展開/收起
- [ ] 提交訂單成功跳轉
- [ ] 購物車清空
- [ ] 客戶資料保存（下次自動載入）

**響應式測試**:
- [ ] 手機版（< 600px）抽屜從底部滑入，高度 70vh
- [ ] 桌面版（≥ 600px）抽屜從右側滑入，寬度 450px

---

### 2. LINE Bot 設定與測試 (7 小時)

#### 2.1 LINE Developers Console 設定 ⭐⭐⭐ (0.5 小時)
**步驟**:
1. [ ] 登入 [LINE Developers Console](https://developers.line.biz/)
2. [ ] 選擇或建立 Provider
3. [ ] 建立 Messaging API Channel
4. [ ] 啟用 "Use webhook"
5. [ ] 設定 Webhook URL: `https://你的域名/api/v1/line/webhook`
6. [ ] 複製 **Channel Access Token**
7. [ ] 複製 **Channel Secret**
8. [ ] 測試 Webhook 連線（應顯示綠燈 ✅）

---

#### 2.2 Railway 環境變數設定 ⭐⭐⭐ (0.1 小時)
**步驟**:
1. [ ] 登入 [Railway Dashboard](https://railway.app/)
2. [ ] 進入專案設定
3. [ ] 新增環境變數:
   ```bash
   LINE_CHANNEL_ACCESS_TOKEN=<剛才複製的Token>
   LINE_CHANNEL_SECRET=<剛才複製的Secret>
   ```
4. [ ] 確認其他環境變數正確:
   ```bash
   DATABASE_URL=postgresql://...  ✅ 已存在
   NODE_ENV=production            ✅ 已存在
   GOOGLE_MAPS_API_KEY=...        ✅ 已存在（可選）
   ```
5. [ ] 儲存並重新部署

---

#### 2.3 LINE 通知完整測試 ⭐⭐ (6.4 小時)

##### 2.3.1 準備測試資料 (1 小時)
- [ ] 在資料庫建立測試 LINE 使用者
  ```sql
  INSERT INTO "LineUser" (id, "lineUserId", phone, "createdAt", "updatedAt")
  VALUES (
    gen_random_uuid(),
    'U1234567890abcdef',  -- 你的 LINE User ID
    '0912345678',          -- 測試電話
    NOW(),
    NOW()
  );
  ```
- [ ] 建立測試商品並設定初始價格
- [ ] 調整系統時間至 14:00-23:59（或修改系統設定）
- [ ] 前台下一個預訂單

##### 2.3.2 測試訂單建立通知 (0.5 小時)
- [ ] 建立新訂單
- [ ] 確認收到 LINE 通知【訂單確認通知】
- [ ] 檢查訂單編號、配送日期、金額正確

##### 2.3.3 測試訂單狀態變更通知 (0.5 小時)
- [ ] 後台更新訂單狀態（準備中、配送中等）
- [ ] 確認收到 LINE 通知【訂單狀態更新】
- [ ] 檢查狀態文字正確

##### 2.3.4 測試價格變動通知 (1.5 小時)
- [ ] 隔天早上（或手動）更新商品價格（變動 > 10%）
- [ ] 後台點擊「檢查價格變動並通知」按鈕
- [ ] 確認收到 LINE 通知【價格變動通知】
- [ ] 檢查通知內容:
  - [ ] 顯示商品名稱、數量、單位
  - [ ] 顯示原價、新價、變動百分比
  - [ ] 顯示訂單總金額變化
  - [ ] 顯示接受/取消指令
- [ ] 檢查資料庫:
  - [ ] `PriceChangeAlert` 記錄已建立
  - [ ] `Order.priceAlertSent = true`
  - [ ] `Order.priceAlertSentAt` 有時間戳記

##### 2.3.5 測試客戶回應處理 (1.5 小時)
**接受訂單**:
- [ ] 在 LINE 回覆「接受 {訂單ID前8碼}」
- [ ] 檢查資料庫:
  - [ ] `Order.priceConfirmed = true`
  - [ ] `PriceChangeAlert.confirmedAt` 已記錄
  - [ ] `PriceChangeAlert.customerResponse = 'accepted'`

**取消訂單**:
- [ ] 建立另一個測試訂單並發送通知
- [ ] 在 LINE 回覆「取消 {訂單ID前8碼}」
- [ ] 檢查資料庫:
  - [ ] `Order.status = 'cancelled'`
  - [ ] `Order.priceConfirmed = false`
  - [ ] `PriceChangeAlert.confirmedAt` 已記錄
  - [ ] `PriceChangeAlert.customerResponse = 'cancelled'`

**測試英文指令**:
- [ ] 測試「ACCEPT {訂單ID}」
- [ ] 測試「CANCEL {訂單ID}」

##### 2.3.6 測試自動接受機制 (1.4 小時)
- [ ] 建立測試訂單並發送價格通知
- [ ] 方案 A: 等待 30 分鐘（較慢）
- [ ] 方案 B: 修改 `priceConfirmTimeout` 為 1 分鐘（推薦）
  ```typescript
  // 後台系統設定頁面
  priceConfirmTimeout: 1  // 改為 1 分鐘
  ```
- [ ] 等待背景服務執行（每 5 分鐘）
- [ ] 檢查資料庫:
  - [ ] `Order.priceConfirmed = true`
  - [ ] `PriceChangeAlert.autoAcceptedAt` 已記錄
  - [ ] `PriceChangeAlert.customerResponse = 'auto-accepted'`
- [ ] 檢查系統日誌有相關記錄
- [ ] 測試完後恢復 `priceConfirmTimeout` 為 30

---

## 🟠 P1 - 高優先級

> **建議本週內完成**
> **預估總時間**: 3 工作日

### 3. 資料庫備份設定 ⭐⭐ (0.5 天)
**目標**: 防止資料遺失

**步驟**:
- [ ] Railway Dashboard → Database → Settings
- [ ] 啟用自動備份 (Automated Backups)
- [ ] 設定備份頻率：每日 (Daily)
- [ ] 設定保留時間：7 天
- [ ] 測試手動備份功能
- [ ] 測試還原功能（使用測試資料庫）
- [ ] 文件記錄備份還原流程

---

### 4. Sentry 錯誤監控整合 ⭐⭐ (0.5 天)
**目標**: 即時監控生產環境錯誤

**步驟**:

#### 4.1 註冊與設定 (1 小時)
- [ ] 註冊 [Sentry](https://sentry.io/) 帳號
- [ ] 建立新專案（Node.js + Next.js）
- [ ] 複製 DSN

#### 4.2 後端整合 (2 小時)
```bash
cd /c/chengyivegetable/apps/api
pnpm add @sentry/node @sentry/tracing
```

```typescript
// apps/api/src/index.ts
import * as Sentry from '@sentry/node';

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 1.0,
});

// 錯誤處理中加入 Sentry
app.use((err, req, res, next) => {
  Sentry.captureException(err);
  // ... 原有錯誤處理
});
```

#### 4.3 前端整合 (1 小時)
```bash
cd /c/chengyivegetable/apps/web
pnpm add @sentry/nextjs
npx @sentry/wizard -i nextjs
```

#### 4.4 測試驗證 (0.5 小時)
- [ ] 手動觸發測試錯誤
- [ ] 確認 Sentry Dashboard 收到錯誤
- [ ] 設定錯誤通知（Email/Slack）

---

### 5. API 速率限制 ⭐⭐ (0.5 天)
**目標**: 防止 API 濫用與 DDoS 攻擊

**步驟**:

#### 5.1 安裝套件 (0.1 小時)
```bash
cd /c/chengyivegetable/apps/api
pnpm add express-rate-limit
```

#### 5.2 實作限制 (2 小時)
```typescript
// apps/api/src/middleware/rate-limit.ts
import rateLimit from 'express-rate-limit';

// 全域限制：每 15 分鐘 100 次請求
export const globalLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 100,
  message: 'Too many requests, please try again later.',
  standardHeaders: true,
  legacyHeaders: false,
});

// 登入限制：每 15 分鐘 5 次嘗試
export const loginLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 5,
  message: 'Too many login attempts, please try again later.',
  skipSuccessfulRequests: true,
});

// 訂單建立限制：每分鐘 3 次
export const orderLimiter = rateLimit({
  windowMs: 60 * 1000,
  max: 3,
  message: 'Too many orders, please slow down.',
});
```

```typescript
// apps/api/src/app.ts
import { globalLimiter, loginLimiter, orderLimiter } from './middleware/rate-limit';

app.use(globalLimiter);
app.use('/api/v1/auth/login', loginLimiter);
app.use('/api/v1/orders', orderLimiter);
```

#### 5.3 測試驗證 (0.5 小時)
- [ ] 快速連續發送請求
- [ ] 確認達到限制後回傳 429 錯誤
- [ ] 等待時間窗口過期後可再次請求

---

### 6. 環境變數驗證 ⭐ (0.5 天)
**目標**: 啟動時檢查必要環境變數

**步驟**:

#### 6.1 建立驗證模組 (2 小時)
```typescript
// apps/api/src/config/env-validator.ts
import { z } from 'zod';

const envSchema = z.object({
  DATABASE_URL: z.string().url(),
  NODE_ENV: z.enum(['development', 'production', 'test']),
  LINE_CHANNEL_ACCESS_TOKEN: z.string().min(1).optional(),
  LINE_CHANNEL_SECRET: z.string().min(1).optional(),
  GOOGLE_MAPS_API_KEY: z.string().min(1).optional(),
  SENTRY_DSN: z.string().url().optional(),
});

export function validateEnv() {
  try {
    envSchema.parse(process.env);
    console.log('✅ Environment variables validated');
  } catch (error) {
    console.error('❌ Invalid environment variables:', error);
    process.exit(1);
  }
}
```

```typescript
// apps/api/src/index.ts
import { validateEnv } from './config/env-validator';

validateEnv();
// ... 其他啟動邏輯
```

#### 6.2 測試驗證 (0.5 小時)
- [ ] 移除必要環境變數
- [ ] 確認應用程式拒絕啟動
- [ ] 恢復環境變數
- [ ] 確認正常啟動

---

### 7. 移除舊結帳頁面 ⭐ (0.1 天)
**目標**: 清理未使用程式碼

**步驟** (0.5 小時):
- [ ] 備份 `apps/web/src/app/checkout` 目錄
  ```bash
  cd /c/chengyivegetable/apps/web/src/app
  tar -czf checkout_backup_$(date +%Y%m%d).tar.gz checkout/
  mv checkout_backup_*.tar.gz ~/backups/
  ```
- [ ] 刪除 `checkout` 目錄
- [ ] 檢查是否有其他檔案引用
- [ ] 測試購物車結帳流程正常
- [ ] Git 提交

---

### 8. PriceCheckService 修正 ⭐ (1 天)
**目標**: 修正使用 createdAt 判斷預訂單的問題

**檔案**: `apps/api/src/domain/price-check-service.ts`

**現況問題**:
```typescript
// 錯誤：使用 createdAt 判斷
const deliveryDate = new Date(order.createdAt || '');
```

**應該改為**:
```typescript
// 正確：使用 deliveryDate 欄位
const deliveryDate = new Date(order.deliveryDate || '');

// 篩選今日配送的預訂單
const preOrders = allOrders.filter(order => {
  const deliveryDate = new Date(order.deliveryDate);
  deliveryDate.setHours(0, 0, 0, 0);

  return (
    order.isPreOrder === true &&
    deliveryDate.getTime() === today.getTime() &&
    order.priceAlertSent === false
  );
});
```

**測試驗證**:
- [ ] 建立昨天下的預訂單（明天配送）
- [ ] 今天檢查價格變動
- [ ] 確認不會檢查到昨天的訂單
- [ ] 只檢查今日配送的預訂單

---

## 🟡 P2 - 中優先級

> **建議 2 週內完成**
> **預估總時間**: 5-7 工作日

### 9. LINE LIFF 綁定流程 (2 天)
**目標**: 讓客戶在 LINE 內綁定電話號碼

**功能需求**:
- LINE 中開啟綁定頁面
- 輸入電話號碼驗證
- 綁定成功後可接收通知

**技術實作**:
- LIFF SDK 整合
- 電話驗證（OTP 簡訊）
- 綁定狀態管理

---

### 10. Driver App 即時通訊 (2 天)
**目標**: 司機與客戶即時溝通

**功能需求**:
- 司機可傳送訊息給客戶
- 客戶可回覆訊息
- 支援文字與圖片

**技術實作**:
- WebSocket 或 Socket.io
- 訊息持久化
- 推播通知整合

---

### 11. CI/CD 增強 (1 天)
**目標**: 自動化測試與部署

**步驟**:
- [ ] GitHub Actions 設定
- [ ] 自動執行測試
- [ ] 自動部署至 Railway
- [ ] Slack 通知整合

---

### 12. Docker 多階段構建 (1 天)
**目標**: 優化部署流程

**步驟**:
- [ ] 建立 Dockerfile (多階段)
- [ ] 優化 image 大小
- [ ] docker-compose.yml
- [ ] 本地測試

---

## 🟢 P3 - 低優先級

> **技術債務與優化**
> **預估總時間**: 3-5 工作日

### 13. 單元測試 (2 天)
**目標**: 提升程式碼品質

**測試範圍**:
- [ ] `useCart` hook 測試
- [ ] `PriceCheckService` 測試
- [ ] `OrderService` 測試
- [ ] `LineWebhookController` 測試
- [ ] 達到 80% 覆蓋率

**工具**: Vitest, React Testing Library

---

### 14. E2E 測試 (1 天)
**目標**: 確保關鍵流程正常

**測試流程**:
- [ ] 完整購物流程
- [ ] 後台訂單管理
- [ ] 價格變動通知流程
- [ ] LINE Bot 回應流程

**工具**: Playwright or Cypress

---

### 15. 效能優化 (2 天)

#### 15.1 價格檢查快取
- [ ] Redis 快取商品價格
- [ ] 減少資料庫查詢

#### 15.2 大量訂單批次處理
- [ ] Bull Queue 整合
- [ ] 背景任務隊列

#### 15.3 LINE API 重試機制
- [ ] 失敗自動重試（最多 3 次）
- [ ] 指數退避策略

---

### 16. 支付流程整合 (3 天)
**目標**: LINE Pay 整合

**功能需求**:
- 訂單付款功能
- 付款狀態追蹤
- 退款處理

---

### 17. 報表統計功能 (2 天)
**目標**: 後台數據分析

**功能需求**:
- 銷售統計
- 訂單趨勢圖
- 商品熱銷排行
- 營收報表

---

### 18. 會員等級系統 (1 天)
**目標**: 會員分級與優惠

**功能需求**:
- 累積消費計算
- 會員等級（銅/銀/金）
- 等級折扣

---

### 19. 商品評價功能 (1 天)
**目標**: 客戶評價與回饋

**功能需求**:
- 訂單完成後評價
- 星級評分
- 文字評論

---

### 20. 優惠券系統 (2 天)
**目標**: 促銷活動支援

**功能需求**:
- 優惠券建立
- 使用規則設定
- 優惠碼兌換

---

## 📊 進度追蹤

### 完成度總覽

| 優先級 | 總任務數 | 已完成 | 進行中 | 待處理 | 完成率 |
|--------|---------|--------|--------|--------|--------|
| 🔴 P0  | 3       | 0      | 0      | 3      | 0%     |
| 🟠 P1  | 6       | 0      | 0      | 6      | 0%     |
| 🟡 P2  | 4       | 0      | 0      | 4      | 0%     |
| 🟢 P3  | 8       | 0      | 0      | 8      | 0%     |
| **總計** | **21** | **0** | **0** | **21** | **0%** |

### 本週目標（2025-10-16 ~ 10-19）

**必須完成** (P0):
- [x] 後端價格驗證
- [x] 後端庫存扣減
- [x] 購物車功能測試
- [x] LINE Bot 設定
- [x] LINE 通知完整測試

**應該完成** (P1):
- [ ] 資料庫備份設定
- [ ] Sentry 錯誤監控
- [ ] API 速率限制
- [ ] 移除舊結帳頁面

---

## ⏰ 時間估算

### 短期 (本週)
**預估總時間**: 13.5 小時 + 2 天 = **約 4 工作日**

### 中期 (兩週內)
**累計總時間**: 4 + 5 = **約 9 工作日**

### 長期 (一個月內)
**累計總時間**: 9 + 10 = **約 19 工作日**

---

## 🎯 建議執行順序

### Week 1 (本週)
```
Day 1: P0.1 價格驗證 (2h) + P0.2 庫存扣減 (4h)
Day 2: P0.3 購物車測試 (0.5h) + P0.2 LINE Bot設定 (0.5h)
Day 3: P0.2 LINE 通知測試 (6h)
Day 4: P1 資料庫備份 + Sentry整合
```

### Week 2
```
Day 5-6: P1 API速率限制 + 環境變數驗證
Day 7-8: P1 PriceCheckService修正 + 程式碼清理
```

### Week 3-4
```
Day 9-10: P2 LINE LIFF 綁定
Day 11-12: P2 Driver App 即時通訊
Day 13-14: P2 CI/CD + Docker
```

---

## ✅ 檢查清單範本

### P0 完成檢查
```
□ 價格驗證已實作並測試
□ 庫存扣減已實作並測試
□ 購物車所有功能測試通過
□ LINE Bot 環境變數已設定
□ LINE 通知所有測試通過
□ 客戶回應處理測試通過
□ 自動接受機制測試通過
```

### P1 完成檢查
```
□ Railway 資料庫備份已啟用
□ Sentry 錯誤監控已整合
□ API 速率限制已實作
□ 環境變數驗證已實作
□ 舊結帳頁面已移除
□ PriceCheckService 已修正
```

---

**最後更新**: 2025-10-15 23:10
**下次更新**: 完成 P0 任務後
