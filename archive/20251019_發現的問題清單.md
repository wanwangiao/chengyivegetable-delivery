# 誠憶鮮蔬線上系統 - 發現的問題清單

**測試日期**: 2025-10-19
**測試環境**: Development
**報告版本**: v1.0

---

## 🔴 Critical / High 嚴重度問題

### BUG-001: Admin Products List API 返回格式不符預期

**嚴重程度**: 🔴 High
**發現時間**: 2025-10-19 22:55
**狀態**: 🔴 Open
**影響模組**: Product Management API
**影響用戶**: 管理員

#### 問題描述
管理員商品列表 API (`GET /api/v1/admin/products`) 返回的資料結構與預期不符，導致前端無法正確解析商品列表。

#### 重現步驟
1. 使用管理員帳號登入 (`admin@chengyi.tw`)
2. 呼叫 API: `GET /api/v1/admin/products`
3. 檢查返回的 JSON 結構

#### 預期行為
```json
{
  "data": {
    "products": [...],
    "stats": {...}
  }
}
```

#### 實際行為
返回結構導致測試中 `response.data.data.products` 不是陣列。

#### 影響範圍
- 管理後台商品列表頁面
- 商品統計資訊顯示
- 依賴此 API 的其他功能

#### 修復建議
1. 檢查 `AdminProductsController.list()` 方法
2. 確認 `ProductService.listWithStats()` 的返回格式
3. 統一 API 返回格式規範，建議使用:
   ```typescript
   {
     data: {
       products: Product[],
       stats: {
         total: number,
         available: number,
         ...
       }
     }
   }
   ```

#### 相關文件
- 文件位置: `apps/api/src/application/controllers/admin-products.controller.ts`
- 服務位置: `apps/api/src/domain/product-service.ts`

---

### BUG-005: 輸入驗證錯誤導致 API 連接失敗

**嚴重程度**: 🔴 High
**發現時間**: 2025-10-19 23:03
**狀態**: 🔴 Open
**影響模組**: API Error Handling
**影響用戶**: 所有用戶

#### 問題描述
當客戶端發送無效的請求資料時，API 拋出 ZodError 但沒有被正確處理，導致客戶端收到連接失敗錯誤而非標準的 HTTP 400 錯誤響應。

#### 重現步驟
1. 發送缺少必填欄位的商品建立請求:
   ```json
   POST /api/v1/products
   {
     "name": "測試商品"
     // 缺少 category, unit 等必填欄位
   }
   ```
2. 觀察客戶端收到的錯誤

#### 預期行為
```json
HTTP 400 Bad Request
{
  "error": "VALIDATION_ERROR",
  "issues": {
    "category": ["Required"],
    "unit": ["Required"]
  }
}
```

#### 實際行為
- 客戶端收到 "Request failed: fetch failed"
- API 日誌顯示未捕獲的 ZodError:
  ```
  ZodError: [
    {
      "code": "invalid_type",
      "expected": "string",
      "received": "undefined",
      "path": [ "category" ],
      "message": "Required"
    }
  ]
  ```

#### 影響範圍
- 所有使用 Zod 驗證的 API 端點
- 用戶體驗差，無法得知具體錯誤原因
- 可能影響前端錯誤處理邏輯

#### 修復建議

1. **在 Controller 層增加錯誤處理**:
   ```typescript
   try {
     const parsed = createProductSchema.parse(req.body);
     // ... 處理邏輯
   } catch (error) {
     if (error instanceof ZodError) {
       return res.status(400).json({
         error: 'VALIDATION_ERROR',
         issues: error.flatten()
       });
     }
     throw error;
   }
   ```

2. **增加全局錯誤處理中間件** (如果尚未完善):
   ```typescript
   app.use((err, req, res, next) => {
     if (err instanceof ZodError) {
       return res.status(400).json({
         error: 'VALIDATION_ERROR',
         issues: err.flatten()
       });
     }
     // ... 其他錯誤處理
   });
   ```

3. **確保所有 async 函數的錯誤都被捕獲**

#### 相關文件
- 文件位置: `apps/api/src/application/controllers/product.controller.ts`
- 錯誤處理: `apps/api/src/app.ts` (全局錯誤處理中間件)

---

## 🟡 Medium 嚴重度問題

### BUG-002: Bulk Upsert 功能無效

**嚴重程度**: 🟡 Medium
**發現時間**: 2025-10-19 22:56
**狀態**: 🔴 Open
**影響模組**: Product Management API
**影響用戶**: 管理員

#### 問題描述
批次新增/更新商品功能 (`POST /api/v1/admin/products/bulk`) 無法建立或更新商品，返回空陣列。

#### 重現步驟
1. 使用管理員帳號登入
2. 準備批次商品資料:
   ```json
   POST /api/v1/admin/products/bulk
   [
     {
       "name": "批次商品1",
       "category": "測試",
       "unit": "個",
       "price": 80,
       "stock": 40,
       "isAvailable": true,
       "isPricedItem": false,
       "options": []
     },
     {
       "name": "批次商品2",
       "category": "測試",
       "unit": "包",
       "price": 120,
       "stock": 25,
       "isAvailable": true,
       "isPricedItem": false,
       "options": []
     }
   ]
   ```
3. 檢查返回結果

#### 預期行為
```json
{
  "data": [
    { "id": "...", "name": "批次商品1", ... },
    { "id": "...", "name": "批次商品2", ... }
  ]
}
```

#### 實際行為
```json
{
  "data": []
}
```

#### 影響範圍
- CSV 匯入功能可能受影響
- 批次商品管理功能無法使用

#### 修復建議
1. 檢查 `ProductService.bulkUpsert()` 方法
2. 驗證資料庫交易是否正確提交
3. 確認請求體解析是否正確
4. 增加日誌輸出以便除錯

#### 相關文件
- 文件位置: `apps/api/src/domain/product-service.ts`
- Controller: `apps/api/src/application/controllers/admin-products.controller.ts`

---

### BUG-003: Reorder Products 功能發生 Undefined 錯誤

**嚴重程度**: 🟡 Medium
**發現時間**: 2025-10-19 22:57
**狀態**: 🔴 Open
**影響模組**: Product Management API
**影響用戶**: 管理員

#### 問題描述
商品排序功能 (`POST /api/v1/admin/products/reorder`) 發生 undefined 錯誤。

#### 錯誤訊息
```
Cannot read properties of undefined (reading 'length')
```

#### 重現步驟
1. 使用管理員帳號登入
2. 取得商品列表
3. 準備排序資料並提交

#### 預期行為
成功更新商品順序

#### 實際行為
發生 undefined 錯誤

#### 可能原因
- BUG-001 的延伸問題（admin products list 返回格式不正確）
- 排序資料驗證邏輯有問題
- 未正確處理空陣列情況

#### 修復建議
1. 先修復 BUG-001
2. 增加輸入資料驗證
3. 增加空陣列檢查
4. 改善錯誤訊息

#### 相關文件
- 文件位置: `apps/api/src/application/controllers/admin-products.controller.ts`

---

### BUG-006: 價格同步操作性能問題

**嚴重程度**: 🟡 Medium
**發現時間**: 2025-10-19 22:58
**狀態**: 🔴 Open
**影響模組**: Product Management Service
**影響用戶**: 管理員

#### 問題描述
同步隔日價格功能執行時間過長，影響用戶體驗。

#### 性能數據
- 執行時間: 4313ms (4.3 秒)
- 預期時間: < 1000ms

#### 影響範圍
- 管理後台操作體驗
- 可能影響其他並發請求

#### 修復建議
1. 使用批次更新而非逐一更新:
   ```typescript
   // 不好的做法
   for (const product of products) {
     await prisma.product.update({...});
   }

   // 較好的做法
   await prisma.$transaction(
     products.map(p =>
       prisma.product.update({...})
     )
   );

   // 最佳做法
   await prisma.product.updateMany({
     data: { ... },
     where: { ... }
   });
   ```

2. 考慮使用背景任務處理
3. 增加進度回饋機制

#### 相關文件
- 文件位置: `apps/api/src/domain/product-service.ts` (syncNextDayPrices 方法)

---

## 🟢 Low 嚴重度問題

### BUG-004: Sync Next Day Prices API 返回格式缺少欄位

**嚴重程度**: 🟢 Low
**發現時間**: 2025-10-19 22:58
**狀態**: 🔴 Open
**影響模組**: Product Management API
**影響用戶**: 管理員

#### 問題描述
同步隔日價格 API 返回資料中缺少 `updated` 欄位，前端無法得知更新了多少商品。

#### 重現步驟
1. 使用管理員帳號登入
2. 呼叫: `POST /api/v1/admin/products/sync-next-day-prices`
3. 檢查返回結果

#### 預期行為
```json
{
  "data": {
    "updated": 6,
    "products": [...]
  }
}
```

#### 實際行為
返回資料中可能缺少 `updated` 欄位

#### 影響範圍
- 前端無法顯示更新成功的商品數量
- 影響用戶體驗

#### 修復建議
確保 `ProductService.syncNextDayPrices()` 返回正確格式:
```typescript
return {
  updated: updated.length,
  products: updated
};
```

#### 相關文件
- 文件位置: `apps/api/src/domain/product-service.ts`

---

## 📊 問題統計

### 按嚴重程度分類
- 🔴 High: 2
- 🟡 Medium: 3
- 🟢 Low: 1
- **總計**: 6

### 按模組分類
- Product Management API: 5
- Error Handling: 1

### 按狀態分類
- 🔴 Open: 6
- 🟢 Fixed: 0
- 🔵 In Progress: 0

---

## 🔧 修復優先級建議

### Phase 1: 緊急修復 (1-2 天)
1. **BUG-005**: 錯誤處理機制 (最高優先)
2. **BUG-001**: Admin Products List API 格式

### Phase 2: 重要修復 (3-4 天)
3. **BUG-006**: 性能優化
4. **BUG-002**: Bulk Upsert 功能
5. **BUG-003**: Reorder 功能

### Phase 3: 一般修復 (5 天後)
6. **BUG-004**: API 返回格式優化

---

## 📝 測試建議

修復完成後，建議執行以下測試：

1. **回歸測試**: 重新執行所有失敗的測試案例
2. **集成測試**: 執行完整的訂單管理和 E2E 流程測試
3. **性能測試**: 驗證優化後的性能改善
4. **UAT 測試**: 讓實際用戶測試修復後的功能

---

## 📞 聯絡資訊

如有疑問或需要更多資訊，請聯絡：
- **QA Team**: qa@chengyi.tw
- **測試報告**: `C:\chengyivegetable\20251019_全功能測試報告.md`

---

**最後更新**: 2025-10-19 23:15
