<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
  <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans:wght@400;500;700;900&family=Space+Grotesk:wght@400;500;700" onload="this.rel='stylesheet'" rel="stylesheet"/>
  <title>誠憶鮮蔬 - 結帳</title>
  <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  
  <!-- PWA 設定 -->
  <meta name="theme-color" content="#22c55e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  
  <style>
    body {
      min-height: max(884px, 100dvh);
      font-family: "Space Grotesk", "Noto Sans", sans-serif;
    }
    .checkout-form input:focus, .checkout-form select:focus, .checkout-form textarea:focus {
      outline: 0;
      ring: 2px solid #10b981;
      border-color: #10b981;
    }
  </style>
</head>

<body class="bg-stone-50">
<div class="relative flex size-full min-h-screen flex-col justify-between group/design-root overflow-x-hidden">
  <main class="flex-grow">
    <!-- Header -->
    <header class="bg-white sticky top-0 z-10 shadow-sm">
      <div class="flex items-center p-4">
        <button class="text-stone-800 flex size-10 shrink-0 items-center justify-center rounded-full hover:bg-stone-100 transition-colors" onclick="goBack()">
          <span class="material-symbols-outlined">arrow_back</span>
        </button>
        <h1 class="text-stone-900 text-xl font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-10">結帳</h1>
      </div>
    </header>

    <!-- Main Content -->
    <section class="p-4 space-y-6 checkout-form">
      <!-- 顧客資訊 -->
      <div>
        <h2 class="text-stone-800 text-lg font-bold leading-tight tracking-[-0.015em] mb-4">顧客資訊</h2>
        <div class="space-y-4">
          <label class="flex flex-col">
            <p class="text-stone-700 text-base font-medium leading-normal pb-2">姓名 <span class="text-red-500">*</span></p>
            <input type="text" name="name" id="customer-name" required
                   class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-stone-900 border-stone-300 bg-white h-14 placeholder:text-stone-400 p-4 text-base font-normal leading-normal"
                   placeholder="請輸入您的姓名"/>
          </label>
          
          <label class="flex flex-col">
            <p class="text-stone-700 text-base font-medium leading-normal pb-2">連絡電話 <span class="text-red-500">*</span></p>
            <input type="tel" name="phone" id="customer-phone" required
                   class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-stone-900 border-stone-300 bg-white h-14 placeholder:text-stone-400 p-4 text-base font-normal leading-normal"
                   placeholder="請輸入您的手機號碼"/>
          </label>
          
          <div class="grid grid-cols-2 gap-4">
            <label class="flex flex-col">
              <p class="text-stone-700 text-base font-medium leading-normal pb-2">縣市 <span class="text-red-500">*</span></p>
              <select name="city" id="customer-city" required
                      class="form-select flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-stone-900 border-stone-300 bg-white h-14 placeholder:text-stone-400 p-4 text-base font-normal leading-normal">
                <option disabled selected>請選擇</option>
                <option value="台北市">台北市</option>
                <option value="新北市">新北市</option>
                <option value="桃園市">桃園市</option>
                <option value="台中市">台中市</option>
                <option value="台南市">台南市</option>
                <option value="高雄市">高雄市</option>
              </select>
            </label>
            <label class="flex flex-col">
              <p class="text-stone-700 text-base font-medium leading-normal pb-2">區域 <span class="text-red-500">*</span></p>
              <select name="district" id="customer-district" required
                      class="form-select flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-stone-900 border-stone-300 bg-white h-14 placeholder:text-stone-400 p-4 text-base font-normal leading-normal">
                <option disabled selected>請選擇</option>
                <option value="中正區">中正區</option>
                <option value="大同區">大同區</option>
                <option value="中山區">中山區</option>
                <option value="松山區">松山區</option>
                <option value="大安區">大安區</option>
                <option value="萬華區">萬華區</option>
                <option value="信義區">信義區</option>
                <option value="士林區">士林區</option>
                <option value="北投區">北投區</option>
                <option value="內湖區">內湖區</option>
                <option value="南港區">南港區</option>
                <option value="文山區">文山區</option>
              </select>
            </label>
          </div>
          
          <label class="flex flex-col">
            <p class="text-stone-700 text-base font-medium leading-normal pb-2">詳細地址 <span class="text-red-500">*</span></p>
            <input type="text" name="address" id="customer-address" required
                   class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-stone-900 border-stone-300 bg-white h-14 placeholder:text-stone-400 p-4 text-base font-normal leading-normal"
                   placeholder="請輸入巷弄、門牌號碼"/>
          </label>
        </div>
      </div>

      <!-- 訂單設定與確認 -->
      <div>
        <h2 class="text-stone-800 text-lg font-bold leading-tight tracking-[-0.015em] mb-4">訂單設定與確認</h2>
        <div class="bg-white rounded-lg shadow-sm divide-y divide-stone-200">
          
          <!-- 付款方式 -->
          <div class="px-4 py-4">
            <div class="flex flex-col justify-center">
              <p class="text-stone-800 text-base font-medium leading-normal line-clamp-1 mb-2">付款方式</p>
              <div class="space-y-3">
                <label class="flex items-center cursor-pointer">
                  <input type="radio" name="paymentMethod" value="cash" checked class="w-4 h-4 text-green-600 border-gray-300 focus:ring-green-500">
                  <span class="ml-3 text-stone-700">貨到付款</span>
                </label>
                <label class="flex items-center cursor-pointer">
                  <input type="radio" name="paymentMethod" value="card" class="w-4 h-4 text-green-600 border-gray-300 focus:ring-green-500">
                  <span class="ml-3 text-stone-700">線上刷卡</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- 備註 -->
          <div class="px-4 py-4">
            <div class="flex flex-col justify-center">
              <p class="text-stone-800 text-base font-medium leading-normal line-clamp-1 mb-2">備註</p>
              <textarea name="notes" id="order-notes" rows="3"
                       class="form-input w-full resize-none rounded-lg text-stone-900 border-stone-300 bg-white p-4 text-base font-normal leading-normal placeholder:text-stone-400"
                       placeholder="有特殊需求嗎？例如：不要洋蔥、送至一樓管理室等"></textarea>
            </div>
          </div>
          
          <!-- 訂購項目 -->
          <div class="px-4 py-4">
            <div class="flex items-center justify-between cursor-pointer" onclick="toggleCartItems()">
              <div class="flex flex-col justify-center">
                <p class="text-stone-800 text-base font-medium leading-normal line-clamp-1">訂購項目</p>
                <p class="text-stone-500 text-sm font-normal leading-normal line-clamp-2" id="cart-summary">載入中...</p>
              </div>
              <div class="shrink-0 text-stone-500">
                <span class="material-symbols-outlined" id="cart-toggle-icon">expand_more</span>
              </div>
            </div>
            
            <!-- 購物車項目詳情 -->
            <div class="mt-4 space-y-3 hidden" id="cart-items-detail">
              <!-- 動態生成購物車項目 -->
            </div>
          </div>
        </div>
      </div>
      
      <!-- 底部間距 -->
      <div class="h-32"></div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bg-white sticky bottom-0 z-10 border-t border-stone-200 p-4">
    <div class="flex items-center justify-between mb-4">
      <div>
        <p class="text-stone-600 font-medium">訂單金額</p>
        <p class="text-xs text-stone-500" id="delivery-info">滿 $200 免運費</p>
      </div>
      <div class="text-right">
        <p class="text-stone-900 text-xl font-bold" id="total-amount">$0</p>
        <p class="text-xs text-stone-500" id="delivery-fee-info">運費: $50</p>
      </div>
    </div>
    <div class="grid grid-cols-2 gap-4">
      <button type="button" onclick="goBack()" 
              class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-stone-200 text-stone-700 text-base font-bold leading-normal tracking-[0.015em] hover:bg-stone-300 transition-colors">
        <span class="truncate">取消</span>
      </button>
      <button type="button" onclick="submitOrder()" id="submit-btn"
              class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 px-5 bg-green-600 text-white text-base font-bold leading-normal tracking-[0.015em] hover:bg-green-700 transition-colors shadow-lg shadow-green-500/30">
        <span class="truncate">送出訂單</span>
      </button>
    </div>
  </footer>
</div>

<script>
// 購物車數據
let cart = JSON.parse(localStorage.getItem('cart')) || [];
let deliveryFee = 50;

// 初始化頁面
function initCheckout() {
  updateCartSummary();
  updateTotalAmount();
  renderCartItems();
}

// 更新購物車摘要
function updateCartSummary() {
  const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
  const summaryElement = document.getElementById('cart-summary');
  if (totalItems > 0) {
    summaryElement.textContent = `${totalItems} 項商品`;
  } else {
    summaryElement.textContent = '購物車為空';
  }
}

// 更新總金額
function updateTotalAmount() {
  const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  const finalDeliveryFee = subtotal >= 200 ? 0 : deliveryFee;
  const total = subtotal + finalDeliveryFee;
  
  document.getElementById('total-amount').textContent = `$${total}`;
  document.getElementById('delivery-fee-info').textContent = finalDeliveryFee > 0 ? `運費: $${finalDeliveryFee}` : '免運費';
  document.getElementById('delivery-info').textContent = subtotal >= 200 ? '已達免運門檻' : '滿 $200 免運費';
}

// 渲染購物車項目
function renderCartItems() {
  const container = document.getElementById('cart-items-detail');
  if (cart.length === 0) {
    container.innerHTML = '<p class="text-stone-500 text-sm">購物車內尚無商品</p>';
    return;
  }
  
  container.innerHTML = cart.map(item => `
    <div class="flex items-center justify-between py-2 border-b border-stone-100 last:border-b-0">
      <div class="flex-1">
        <p class="text-stone-800 font-medium">${item.name}</p>
        <p class="text-stone-500 text-sm">單價: $${item.price}</p>
      </div>
      <div class="flex items-center gap-3">
        <span class="text-stone-600">×${item.quantity}</span>
        <span class="text-green-600 font-bold">$${item.price * item.quantity}</span>
      </div>
    </div>
  `).join('');
}

// 切換購物車項目顯示
function toggleCartItems() {
  const detail = document.getElementById('cart-items-detail');
  const icon = document.getElementById('cart-toggle-icon');
  
  if (detail.classList.contains('hidden')) {
    detail.classList.remove('hidden');
    icon.textContent = 'expand_less';
  } else {
    detail.classList.add('hidden');
    icon.textContent = 'expand_more';
  }
}

// 返回上一頁
function goBack() {
  window.history.back();
}

// 提交訂單
async function submitOrder() {
  // 驗證必填欄位
  const name = document.getElementById('customer-name').value.trim();
  const phone = document.getElementById('customer-phone').value.trim();
  const city = document.getElementById('customer-city').value;
  const district = document.getElementById('customer-district').value;
  const address = document.getElementById('customer-address').value.trim();
  
  if (!name || !phone || !city || !district || !address) {
    alert('請填寫所有必填欄位');
    return;
  }
  
  if (cart.length === 0) {
    alert('購物車為空，無法下單');
    return;
  }
  
  // 手機號碼格式驗證
  const phoneRegex = /^09\d{8}$/;
  if (!phoneRegex.test(phone)) {
    alert('請輸入正確的手機號碼格式 (09XXXXXXXX)');
    return;
  }
  
  // 準備訂單資料
  const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
  const notes = document.getElementById('order-notes').value.trim();
  const fullAddress = `${city}${district}${address}`;
  
  const orderData = {
    name: name,
    phone: phone,
    address: fullAddress,
    notes: notes,
    paymentMethod: paymentMethod,
    items: cart.map(item => ({
      productId: item.productId,
      quantity: item.quantity
    }))
  };
  
  // 顯示載入狀態
  const submitBtn = document.getElementById('submit-btn');
  const originalText = submitBtn.innerHTML;
  submitBtn.innerHTML = '<span class="truncate">送出中...</span>';
  submitBtn.disabled = true;
  
  try {
    const response = await fetch('/api/orders', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(orderData)
    });
    
    const result = await response.json();
    
    if (result.success) {
      // 清空購物車
      localStorage.removeItem('cart');
      
      // 跳轉到成功頁面
      window.location.href = `/order-success?orderId=${result.orderId}`;
    } else {
      alert(`下單失敗: ${result.message}`);
    }
  } catch (error) {
    console.error('下單錯誤:', error);
    alert('下單失敗，請稍後再試');
  } finally {
    // 恢復按鈕狀態
    submitBtn.innerHTML = originalText;
    submitBtn.disabled = false;
  }
}

// 頁面載入時初始化
document.addEventListener('DOMContentLoaded', initCheckout);
</script>

</body>
</html>