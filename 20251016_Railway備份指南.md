# Railway PostgreSQL è‡ªå‹•å‚™ä»½è¨­å®šæŒ‡å—

> å»ºç«‹æ—¥æœŸ: 2025-10-16
> å„ªå…ˆç´š: P0 - è³‡æ–™ä¿è­·

---

## ğŸ¯ ç›®æ¨™

è¨­å®š Railway PostgreSQL è³‡æ–™åº«çš„è‡ªå‹•å‚™ä»½,ç¢ºä¿è³‡æ–™å®‰å…¨ã€‚

---

## ğŸ“‹ è¨­å®šæ­¥é©Ÿ

### æ­¥é©Ÿ 1: ç™»å…¥ Railway Dashboard

1. å‰å¾€ https://railway.app/
2. é¸æ“‡ `chengyivegetable` å°ˆæ¡ˆ
3. æ‰¾åˆ° **PostgreSQL** æœå‹™

### æ­¥é©Ÿ 2: å•Ÿç”¨è‡ªå‹•å‚™ä»½

**Railway æä¾›çš„å‚™ä»½é¸é …**:

#### é¸é … A: Railway å…§å»ºå‚™ä»½ (æ¨è–¦)

1. é»æ“Š PostgreSQL æœå‹™
2. åˆ‡æ›åˆ° **"Backups"** æ¨™ç±¤
3. é»æ“Š **"Enable Automatic Backups"**
4. è¨­å®šå‚™ä»½é »ç‡:
   - **æ¯æ—¥å‚™ä»½**: å»ºè­°æ™‚é–“ `03:00 UTC` (å°ç£æ™‚é–“ 11:00)
   - **ä¿ç•™å¤©æ•¸**: 7 å¤© (å…è²»æ–¹æ¡ˆä¸Šé™)

#### é¸é … B: ä½¿ç”¨ pg_dump å®šæœŸå‚™ä»½

å¦‚æœ Railway å…è²»æ–¹æ¡ˆä¸æ”¯æ´è‡ªå‹•å‚™ä»½,å¯ä»¥ä½¿ç”¨å¤–éƒ¨æœå‹™:

**ä½¿ç”¨ GitHub Actions å®šæœŸå‚™ä»½**:

```yaml
# .github/workflows/db-backup.yml
name: Database Backup

on:
  schedule:
    - cron: '0 3 * * *'  # æ¯å¤© UTC 03:00 (å°ç£ 11:00)
  workflow_dispatch:     # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Backup Database
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          pg_dump "${{ secrets.DATABASE_URL }}" > backup_${TIMESTAMP}.sql

      - name: Upload to storage
        run: |
          # ä¸Šå‚³åˆ° Google Drive / AWS S3 / GitHub Release
          echo "Backup completed"
```

---

## ğŸ§ª é©—è­‰å‚™ä»½è¨­å®š

### æ–¹æ³• 1: Railway Dashboard æª¢æŸ¥

1. å‰å¾€ PostgreSQL æœå‹™çš„ "Backups" é é¢
2. ç¢ºèªçœ‹åˆ°å‚™ä»½åˆ—è¡¨
3. ç¢ºèªæœ€æ–°å‚™ä»½æ™‚é–“

### æ–¹æ³• 2: æ¸¬è©¦æ¢å¾©æµç¨‹

```bash
# 1. åˆ—å‡ºæ‰€æœ‰å‚™ä»½
railway backups list

# 2. ä¸‹è¼‰æœ€æ–°å‚™ä»½
railway backups download <backup-id>

# 3. æ¸¬è©¦æ¢å¾©åˆ°æœ¬åœ°è³‡æ–™åº«
psql -h localhost -U postgres -d test_restore < backup.sql

# 4. é©—è­‰è³‡æ–™å®Œæ•´æ€§
psql -h localhost -U postgres -d test_restore -c "SELECT COUNT(*) FROM \"Order\";"
psql -h localhost -U postgres -d test_restore -c "SELECT COUNT(*) FROM \"Product\";"
psql -h localhost -U postgres -d test_restore -c "SELECT COUNT(*) FROM \"User\";"
```

---

## ğŸ“Š å‚™ä»½ç­–ç•¥å»ºè­°

### ç”Ÿç”¢ç’°å¢ƒå‚™ä»½æ–¹æ¡ˆ

| å‚™ä»½é¡å‹ | é »ç‡ | ä¿ç•™æœŸé™ | å„²å­˜ä½ç½® |
|---------|------|---------|---------|
| è‡ªå‹•å‚™ä»½ | æ¯æ—¥ | 7 å¤© | Railway |
| å®Œæ•´å‚™ä»½ | æ¯é€± | 4 é€± | å¤–éƒ¨å„²å­˜ (S3/GCS) |
| é‡è¦ç¯€é» | æ‰‹å‹• | æ°¸ä¹… | å¤–éƒ¨å„²å­˜ |

### é‡è¦æ™‚æ©Ÿæ‰‹å‹•å‚™ä»½

1. **éƒ¨ç½²å‰**: é‡å¤§æ›´æ–°æˆ– schema è®Šæ›´å‰
2. **è³‡æ–™é·ç§»å‰**: å¤§é‡è³‡æ–™å°å…¥/åŒ¯å‡ºå‰
3. **é‡è¦ç¯€é»**: æ¯æœˆåº•ã€å­£åº¦æœ«

---

## ğŸ” å‚™ä»½å®‰å…¨æ³¨æ„äº‹é …

1. **åŠ å¯†å‚™ä»½æª”æ¡ˆ**:
   ```bash
   # ä½¿ç”¨ GPG åŠ å¯†
   gpg --symmetric --cipher-algo AES256 backup.sql
   ```

2. **é™åˆ¶å­˜å–æ¬Šé™**: å‚™ä»½æª”æ¡ˆåƒ…æˆæ¬Šçµ¦å¿…è¦äººå“¡

3. **ç•°åœ°å‚™ä»½**: è‡³å°‘ä¿å­˜ä¸€ä»½å‚™ä»½åœ¨ä¸åŒåœ°ç†ä½ç½®

4. **å®šæœŸæ¸¬è©¦æ¢å¾©**: æ¯æœˆè‡³å°‘æ¸¬è©¦ä¸€æ¬¡æ¢å¾©æµç¨‹

---

## ğŸš¨ ç½é›£æ¢å¾©è¨ˆç•«

### æƒ…å¢ƒ 1: è³‡æ–™åº«å®Œå…¨ææ¯€

```bash
# 1. å»ºç«‹æ–°çš„è³‡æ–™åº«
railway create database

# 2. æ¢å¾©æœ€æ–°å‚™ä»½
railway backups restore <backup-id>

# 3. æ›´æ–° DATABASE_URL ç’°å¢ƒè®Šæ•¸
railway variables set DATABASE_URL="æ–°è³‡æ–™åº«é€£ç·šå­—ä¸²"

# 4. é‡æ–°éƒ¨ç½²æœå‹™
railway up
```

### æƒ…å¢ƒ 2: èª¤åˆªé™¤è³‡æ–™

```bash
# 1. ç«‹å³åœæ­¢æœå‹™ (é¿å…æ›´å¤šè³‡æ–™è®Šæ›´)
railway service stop

# 2. æ¢å¾©å‚™ä»½åˆ°è‡¨æ™‚è³‡æ–™åº«
psql -h localhost -U postgres -d temp_restore < backup.sql

# 3. åŒ¯å‡ºéœ€è¦çš„è³‡æ–™
pg_dump -h localhost -U postgres -d temp_restore -t specific_table > recovered_data.sql

# 4. åŒ¯å…¥åˆ°ç”Ÿç”¢è³‡æ–™åº«
psql "$DATABASE_URL" < recovered_data.sql

# 5. é‡å•Ÿæœå‹™
railway service start
```

---

## âœ… æª¢æŸ¥æ¸…å–®

å®Œæˆä»¥ä¸‹æª¢æŸ¥æ¸…å–®,ç¢ºä¿å‚™ä»½è¨­å®šå®Œæ•´:

- [ ] Railway PostgreSQL è‡ªå‹•å‚™ä»½å·²å•Ÿç”¨
- [ ] å‚™ä»½é »ç‡è¨­å®šç‚ºæ¯æ—¥
- [ ] å‚™ä»½ä¿ç•™å¤©æ•¸è¨­å®šç‚º 7 å¤©
- [ ] å·²æ‰‹å‹•è§¸ç™¼ä¸€æ¬¡å‚™ä»½æ¸¬è©¦
- [ ] å·²ä¸‹è¼‰ä¸¦é©—è­‰å‚™ä»½æª”æ¡ˆ
- [ ] å·²æ¸¬è©¦å‚™ä»½æ¢å¾©æµç¨‹
- [ ] åœ˜éšŠæˆå“¡çŸ¥é“å¦‚ä½•å­˜å–å‚™ä»½
- [ ] å·²å»ºç«‹ç½é›£æ¢å¾©æ–‡ä»¶

---

## ğŸ“ ç·Šæ€¥è¯çµ¡

å¦‚é‡è³‡æ–™åº«ç½é›£:

1. ç«‹å³é€šçŸ¥æŠ€è¡“è² è²¬äºº
2. åœæ­¢æ‰€æœ‰å¯«å…¥æ“ä½œ
3. è©•ä¼°è³‡æ–™æå¤±ç¯„åœ
4. åŸ·è¡Œç½é›£æ¢å¾©è¨ˆç•«
5. é€šçŸ¥å—å½±éŸ¿çš„ä½¿ç”¨è€…

---

## ğŸ“ å‚™ä»½è¨˜éŒ„

| æ—¥æœŸ | å‚™ä»½é¡å‹ | åŸ·è¡Œäºº | ç‹€æ…‹ | å‚™è¨» |
|------|---------|-------|------|------|
| 2025-10-16 | è¨­å®šå•Ÿç”¨ | - | â³ å¾…å®Œæˆ | åˆå§‹è¨­å®š |
| | | | | |

---

**æœ€å¾Œæ›´æ–°**: 2025-10-16
**è² è²¬äºº**: DevOps Team
