# 🗄️ 資料庫遷移執行指南

## 📋 目標
為 `orders` 表添加 `payment_method` 欄位，修復前台結帳功能。

## 🚀 執行方式

### 方法1：使用 Railway CLI（推薦）

如果您有安裝 Railway CLI：

```bash
# 1. 連接到資料庫
railway run psql $DATABASE_URL

# 2. 執行 SQL 檔案
\i manual_migration.sql
```

### 方法2：使用 psql 客戶端

如果您有安裝 PostgreSQL 客戶端：

```bash
# Windows (需要安裝 PostgreSQL)
psql -h db-postgresql-sgp1-67006-do-user-16407903-0.c.db.ondigitalocean.com -p 25060 -U doadmin -d defaultdb -f manual_migration.sql

# 或者複製貼上執行
psql -h db-postgresql-sgp1-67006-do-user-16407903-0.c.db.ondigitalocean.com -p 25060 -U doadmin -d defaultdb
```

### 方法3：使用網頁版資料庫管理工具

1. **pgAdmin** (如果有安裝)
2. **Railway Dashboard** (如果 Railway 提供資料庫管理介面)
3. **DigitalOcean 控制台** (如果有提供)

### 方法4：直接複製 SQL 執行

如果您有任何 PostgreSQL 管理工具，直接執行以下 SQL：

```sql
-- 添加 payment_method 欄位
DO $$ 
BEGIN 
    IF NOT EXISTS (
        SELECT 1 
        FROM information_schema.columns 
        WHERE table_name = 'orders' 
        AND column_name = 'payment_method'
    ) THEN
        ALTER TABLE orders ADD COLUMN payment_method TEXT DEFAULT 'cash';
        UPDATE orders SET payment_method = 'cash' WHERE payment_method IS NULL;
        RAISE NOTICE '✅ payment_method 欄位已成功添加';
    ELSE
        RAISE NOTICE '⚠️ payment_method 欄位已存在';
    END IF;
END $$;

-- 建立索引
CREATE INDEX IF NOT EXISTS idx_orders_payment_method ON orders(payment_method);
```

## 🔍 驗證步驟

執行完成後，運行以下查詢來確認：

```sql
-- 1. 檢查欄位是否存在
SELECT column_name, data_type, column_default 
FROM information_schema.columns 
WHERE table_name = 'orders' AND column_name = 'payment_method';

-- 2. 檢查現有資料
SELECT payment_method, COUNT(*) as count 
FROM orders 
GROUP BY payment_method;
```

## ✅ 預期結果

執行成功後應該看到：

1. **欄位資訊**：
   - column_name: `payment_method`
   - data_type: `text`
   - column_default: `'cash'::text`

2. **資料分布**：
   - 所有現有訂單的 `payment_method` 都是 `'cash'`

3. **通知訊息**：
   - `✅ payment_method 欄位已成功添加到 orders 表`

## 🚨 注意事項

1. **備份**：執行前建議備份資料（如果是生產環境）
2. **權限**：確保您有 ALTER TABLE 權限
3. **連線**：確保資料庫連線正常
4. **密碼**：您需要資料庫密碼才能連接

## 🆘 如果遇到問題

1. **權限不足**：聯繫資料庫管理員
2. **連線失敗**：檢查網路和憑證
3. **SQL 錯誤**：檢查語法或聯繫技術支援

## 📞 需要協助？

如果您在執行過程中遇到任何問題，請告訴我：
- 使用的執行方法
- 遇到的錯誤訊息
- 目前的資料庫連線狀況